{% extends "layout.html" %}
{% block content %}

<div class="glass border border-slate-900/10 dark:border-white/20 rounded-2xl p-6 space-y-5
            bg-white/70 dark:bg-white/5">

  <!-- CABE√áALHO DA P√ÅGINA -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold text-slate-900 dark:text-white">
        üöó Controle de Entrada e Sa√≠da
      </h1>
      <p class="text-sm text-slate-600 dark:text-gray-300 mt-1">
        O primeiro registro do ve√≠culo √© sempre <b>Sa√≠da</b>. Depois, registre a <b>Chegada</b> no bot√£o.
      </p>
    </div>

    <div class="flex items-center gap-2">
      <button type="button"
              onclick="abrirModalSaida()"
              class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow-lg">
        + Nova Sa√≠da
      </button>
    </div>
  </div>

  <!-- TABELA / HIST√ìRICO -->
  <div class="border-t border-slate-900/10 dark:border-white/20 pt-5">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-white">
        üìã Registros
      </h2>
      <p class="text-xs text-slate-500 dark:text-gray-400">
        Total: {{ registros|length if registros else 0 }}
      </p>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm border border-slate-900/10 dark:border-white/20 rounded-lg overflow-hidden">
        <thead class="bg-slate-900/5 dark:bg-white/10 text-slate-600 dark:text-gray-300">
          <tr>
            <th class="px-3 py-2 text-left">Sa√≠da</th>
            <th class="px-3 py-2 text-left">Chegada</th>
            <th class="px-3 py-2 text-left">Ve√≠culo</th>
            <th class="px-3 py-2 text-left">KM Sa√≠da</th>
            <th class="px-3 py-2 text-left">KM Chegada</th>
            <th class="px-3 py-2 text-left">Respons√°vel</th>
            <th class="px-3 py-2 text-left">Obs.</th>
            <th class="px-3 py-2 text-left">A√ß√£o</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-slate-900/10 dark:divide-white/10 text-slate-900 dark:text-gray-200">
          {% for r in registros %}
          {% set s = r.saida %}
          {% set c = r.chegada %}
          <tr class="hover:bg-slate-900/5 dark:hover:bg-white/5">
            <td class="px-3 py-2 whitespace-nowrap">
              {{ s.data_hora | br_datetime }}
            </td>

            <td class="px-3 py-2 whitespace-nowrap">
              {% if c %}
                {{ c.data_hora | br_datetime }}
              {% else %}
                <span class="text-slate-400 dark:text-gray-500">‚Äî</span>
              {% endif %}
            </td>

            <td class="px-3 py-2 whitespace-nowrap">
              {% if s.vehicle %}
                <span class="font-semibold text-slate-900 dark:text-gray-100">{{ s.vehicle.plate }}</span>
                <span class="text-slate-500 dark:text-gray-400">‚Äî {{ s.vehicle.brand }} {{ s.vehicle.model }}</span>
              {% else %}
                <span class="text-slate-500 dark:text-gray-300">‚Äî</span>
              {% endif %}
            </td>

            <td class="px-3 py-2 whitespace-nowrap">
              {{ s.km }}
            </td>

            <td class="px-3 py-2 whitespace-nowrap">
              {% if c %}
                {{ c.km }}
              {% else %}
                <span class="text-slate-400 dark:text-gray-500">‚Äî</span>
              {% endif %}
            </td>

            <td class="px-3 py-2 whitespace-nowrap">
              {{ s.responsavel }}
            </td>

            <td class="px-3 py-2">
              <span class="text-slate-700 dark:text-gray-300">
                {{ s.obs if s.obs else "‚Äî" }}
                {% if c and c.obs %}
                  <span class="text-slate-400 dark:text-gray-500"> | Chegada: </span>{{ c.obs }}
                {% endif %}
              </span>
            </td>

            <!-- A√á√ÉO -->
            <td class="px-3 py-2 whitespace-nowrap">
              {% if r.pode_registrar_chegada %}
                <button type="button"
                        onclick="abrirModalChegada('{{ s.vehicle_id }}','{{ s.id }}','{{ s.km }}','{{ s.responsavel }}')"
                        class="px-3 py-1.5 rounded-lg
                               bg-green-600/20 dark:bg-green-600/25
                               border border-green-600/25 dark:border-green-600/30
                               hover:bg-green-600/30 dark:hover:bg-green-600/35
                               text-green-800 dark:text-green-200 font-semibold">
                  Registrar chegada
                </button>
              {% else %}
                <span class="text-slate-400 dark:text-gray-500">Finalizado</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="px-3 py-6 text-center text-slate-500 dark:text-gray-400">
              Nenhum registro encontrado.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- =========================
     MODAL 1: NOVA SA√çDA
========================= -->
<div id="modalSaida" class="fixed inset-0 hidden z-[9999] items-center justify-center">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="fecharModalSaida()"></div>

  <div class="relative w-full max-w-2xl mx-4 rounded-2xl
              border border-slate-900/10 dark:border-white/20
              bg-white/90 dark:bg-gray-950/70
              dark:glass shadow-2xl overflow-hidden">

    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-900/10 dark:border-white/10">
      <div>
        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">+ Nova Sa√≠da</h3>
        <p class="text-xs text-slate-500 dark:text-gray-400">Registro de sa√≠da do ve√≠culo</p>
      </div>

      <button type="button" onclick="fecharModalSaida()"
              class="w-10 h-10 grid place-items-center rounded-lg
                     bg-slate-900/5 hover:bg-slate-900/10 border border-slate-900/10
                     dark:bg-white/5 dark:hover:bg-white/10 dark:border-white/10">
        <span class="text-slate-700 dark:text-gray-200 text-xl">√ó</span>
      </button>
    </div>

    <form method="POST" action="{{ url_for('controle_veiculos') }}"
          class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">

      <input type="hidden" name="tipo" value="saida">

      <!-- VE√çCULO -->
      <div>
        <label class="block text-sm text-slate-700 dark:text-gray-300 mb-1">Ve√≠culo</label>
        <select name="vehicle_id" id="saida_vehicle_id" required
                class="w-full rounded-lg
                       bg-white dark:bg-gray-900
                       border border-slate-900/10 dark:border-white/20
                       px-3 py-2
                       text-slate-900 dark:text-white
                       focus:outline-none focus:ring-2 focus:ring-blue-600/40">
          <option value="">Selecione o ve√≠culo</option>
          {% for v in vehicles %}
            <option value="{{ v.id }}">{{ v.plate }} ‚Äî {{ v.brand }} {{ v.model }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- TIPO VISUAL -->
      <div>
        <label class="block text-sm text-slate-700 dark:text-gray-300 mb-1">Tipo</label>
        <input type="text" value="Sa√≠da" readonly
               class="w-full rounded-lg
                      bg-slate-100 dark:bg-gray-800
                      border border-slate-900/10 dark:border-white/10
                      px-3 py-2
                      text-slate-600 dark:text-gray-300
                      cursor-not-allowed">
      </div>

      <!-- KM -->
      <div>
        <label class="block text-sm text-slate-700 dark:text-gray-300 mb-1">Quilometragem</label>
        <input type="number" name="km" id="saida_km" min="0" required
               placeholder="Ex: 45230"
               class="w-full rounded-lg
                      bg-white dark:bg-gray-900
                      border border-slate-900/10 dark:border-white/20
                      px-3 py-2
                      text-slate-900 dark:text-white
                      placeholder:text-slate-400 dark:placeholder:text-gray-500
                      focus:outline-none focus:ring-2 focus:ring-blue-600/40">
      </div>

      <!-- RESPONS√ÅVEL -->
      <div>
        <label class="block text-sm text-slate-700 dark:text-gray-300 mb-1">Respons√°vel</label>
        <select name="responsavel" id="saida_responsavel" required
                class="w-full rounded-lg
                       bg-white dark:bg-gray-900
                       border border-slate-900/10 dark:border-white/20
                       px-3 py-2
                       text-slate-900 dark:text-white
                       focus:outline-none focus:ring-2 focus:ring-blue-600/40">
          {% for u in usuarios %}
            <option value="{{ u.username }}" {% if u.username == current_user.username %}selected{% endif %}>
              {{ u.username }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- OBS -->
      <div class="md:col-span-2">
        <label class="block text-sm text-slate-700 dark:text-gray-300 mb-1">Observa√ß√µes</label>
        <textarea name="obs" id="saida_obs" rows="3"
                  placeholder="Destino, servi√ßo, ocorr√™ncia, etc."
                  class="w-full rounded-lg
                         bg-white dark:bg-gray-900
                         border border-slate-900/10 dark:border-white/20
                         px-3 py-2
                         text-slate-900 dark:text-white
                         placeholder:text-slate-400 dark:placeholder:text-gray-500
                         focus:outline-none focus:ring-2 focus:ring-blue-600/40"></textarea>
      </div>

      <div class="md:col-span-2 flex justify-end gap-2 pt-2">
        <button type="button" onclick="fecharModalSaida()"
                class="px-4 py-2 rounded-lg
                       bg-slate-900/5 hover:bg-slate-900/10 border border-slate-900/10 text-slate-800
                       dark:bg-white/5 dark:hover:bg-white/10 dark:border-white/10 dark:text-gray-200">
          Cancelar
        </button>

        <button type="submit"
                class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow-lg">
          Salvar Sa√≠da
        </button>
      </div>
    </form>
  </div>
</div>

<!-- =========================
     MODAL 2: REGISTRAR CHEGADA
========================= -->
<div id="modalChegada" class="fixed inset-0 hidden z-[9999] items-center justify-center">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="fecharModalChegada()"></div>

  <div class="relative w-full max-w-2xl mx-4 rounded-2xl
              border border-slate-900/10 dark:border-white/20
              bg-white/90 dark:bg-gray-950/70
              dark:glass shadow-2xl overflow-hidden">

    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-900/10 dark:border-white/10">
      <div>
        <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Registrar Chegada</h3>
        <p class="text-xs text-slate-500 dark:text-gray-400">Finalize a sa√≠da registrando a entrada do ve√≠culo</p>
      </div>

      <button type="button" onclick="fecharModalChegada()"
              class="w-10 h-10 grid place-items-center rounded-lg
                     bg-slate-900/5 hover:bg-slate-900/10 border border-slate-900/10
                     dark:bg-white/5 dark:hover:bg-white/10 dark:border-white/10">
        <span class="text-slate-700 dark:text-gray-200 text-xl">√ó</span>
      </button>
    </div>

    <form method="POST" action="{{ url_for('controle_veiculos') }}"
          class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">

      <input type="hidden" name="tipo" value="entrada">
      <input type="hidden" name="saida_id" id="chegada_saida_id" value="">
      <input type="hidden" name="vehicle_id" id="chegada_vehicle_id" value="">

      <!-- VE√çCULO VISUAL -->
      <div>
        <label class="block text-sm text-slate-700 dark:text-gray-300 mb-1">Ve√≠culo</label>
        <input type="text" id="chegada_veiculo_label" readonly
               class="w-full rounded-lg
                      bg-slate-100 dark:bg-gray-800
                      border border-slate-900/10 dark:border-white/10
                      px-3 py-2
                      text-slate-600 dark:text-gray-300
                      cursor-not-allowed">
        <p class="text-xs text-slate-500 dark:text-gray-500 mt-1">Vinculado √† sa√≠da selecionada.</p>
      </div>

      <!-- TIPO VISUAL -->
      <div>
        <label class="block text-sm text-slate-700 dark:text-gray-300 mb-1">Tipo</label>
        <input type="text" value="Chegada (Entrada)" readonly
               class="w-full rounded-lg
                      bg-slate-100 dark:bg-gray-800
                      border border-slate-900/10 dark:border-white/10
                      px-3 py-2
                      text-slate-600 dark:text-gray-300
                      cursor-not-allowed">
      </div>

      <!-- KM -->
      <div>
        <label class="block text-sm text-slate-700 dark:text-gray-300 mb-1">Quilometragem na chegada</label>
        <input type="number" name="km" id="chegada_km" min="0" required
               placeholder="Ex: 45890"
               class="w-full rounded-lg
                      bg-white dark:bg-gray-900
                      border border-slate-900/10 dark:border-white/20
                      px-3 py-2
                      text-slate-900 dark:text-white
                      placeholder:text-slate-400 dark:placeholder:text-gray-500
                      focus:outline-none focus:ring-2 focus:ring-green-600/40">
        <p class="text-xs text-slate-500 dark:text-gray-500 mt-1" id="chegada_km_hint"></p>
      </div>

      <!-- RESPONS√ÅVEL -->
      <div>
        <label class="block text-sm text-slate-700 dark:text-gray-300 mb-1">Respons√°vel</label>
        <select name="responsavel" id="chegada_responsavel" required
                class="w-full rounded-lg
                       bg-white dark:bg-gray-900
                       border border-slate-900/10 dark:border-white/20
                       px-3 py-2
                       text-slate-900 dark:text-white
                       focus:outline-none focus:ring-2 focus:ring-green-600/40">
          {% for u in usuarios %}
            <option value="{{ u.username }}" {% if u.username == current_user.username %}selected{% endif %}>
              {{ u.username }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- OBS -->
      <div class="md:col-span-2">
        <label class="block text-sm text-slate-700 dark:text-gray-300 mb-1">Observa√ß√µes</label>
        <textarea name="obs" id="chegada_obs" rows="3"
                  placeholder="Ocorr√™ncia na volta, abastecimento, avaria, etc."
                  class="w-full rounded-lg
                         bg-white dark:bg-gray-900
                         border border-slate-900/10 dark:border-white/20
                         px-3 py-2
                         text-slate-900 dark:text-white
                         placeholder:text-slate-400 dark:placeholder:text-gray-500
                         focus:outline-none focus:ring-2 focus:ring-green-600/40"></textarea>
      </div>

      <div class="md:col-span-2 flex justify-end gap-2 pt-2">
        <button type="button" onclick="fecharModalChegada()"
                class="px-4 py-2 rounded-lg
                       bg-slate-900/5 hover:bg-slate-900/10 border border-slate-900/10 text-slate-800
                       dark:bg-white/5 dark:hover:bg-white/10 dark:border-white/10 dark:text-gray-200">
          Cancelar
        </button>

        <button type="submit"
                class="px-6 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold shadow-lg">
          Salvar Chegada
        </button>
      </div>

    </form>
  </div>
</div>

<script>
  function abrirModal(id) {
    const m = document.getElementById(id);
    if (!m) return;
    m.classList.remove("hidden");
    m.classList.add("flex");
  }

  function fecharModal(id) {
    const m = document.getElementById(id);
    if (!m) return;
    m.classList.add("hidden");
    m.classList.remove("flex");
  }

  // ===== SA√çDA =====
  function abrirModalSaida() {
    const vid = document.getElementById("saida_vehicle_id");
    const km  = document.getElementById("saida_km");
    const obs = document.getElementById("saida_obs");
    if (vid) vid.value = "";
    if (km) km.value = "";
    if (obs) obs.value = "";
    abrirModal("modalSaida");
  }

  function fecharModalSaida() {
    fecharModal("modalSaida");
  }

  // ===== CHEGADA =====
  function abrirModalChegada(vehicleId, saidaId, kmSaida, responsavelSaida) {
    document.getElementById("chegada_vehicle_id").value = vehicleId;
    document.getElementById("chegada_saida_id").value = saidaId;

    // label ve√≠culo (puxa do select da sa√≠da)
    const selectAll = document.getElementById("saida_vehicle_id");
    let label = "Ve√≠culo selecionado";
    if (selectAll) {
      const opt = [...selectAll.options].find(o => o.value === String(vehicleId));
      if (opt) label = opt.textContent.trim();
    }
    document.getElementById("chegada_veiculo_label").value = label;

    document.getElementById("chegada_km").value = kmSaida || "";
    document.getElementById("chegada_km_hint").textContent =
      kmSaida ? ("KM da sa√≠da: " + kmSaida + " ‚Äî informe a quilometragem atual da chegada.") : "";

    document.getElementById("chegada_obs").value = "";

    // opcional: j√° selecionar o mesmo respons√°vel da sa√≠da
    const sel = document.getElementById("chegada_responsavel");
    if (sel && responsavelSaida) sel.value = responsavelSaida;

    abrirModal("modalChegada");
  }

  function fecharModalChegada() {
    fecharModal("modalChegada");
  }

  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    fecharModalSaida();
    fecharModalChegada();
  });
</script>

{% endblock %}
