{% extends 'layout.html' %}
{% set page_title = "Ve√≠culos" %}
{% block content %}

<style>
  /* backdrop premium */
  dialog::backdrop{
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(3px);
  }
</style>

<!-- ===============================
      CABE√áALHO + BUSCA + NOVO
================================ -->
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-10 gap-4">

  <h2 class="text-3xl font-bold tracking-wide text-white drop-shadow">
    üöó Ve√≠culos
  </h2>

  <div class="flex items-center gap-3 w-full lg:w-auto">

      <!-- BUSCA -->
      <form method="get" class="flex items-center gap-2 flex-1">
        <input name="q" value="{{ q }}" placeholder="Buscar por placa, marca ou modelo..."
               class="flex-1 bg-gray-900/60 border border-white/10 rounded-xl px-4 py-2 text-gray-200 
                      focus:ring-2 focus:ring-blue-600 shadow">
        <button class="px-6 bg-blue-600 hover:bg-blue-500 rounded-xl text-white font-medium shadow">
          Buscar
        </button>
      </form>

      <!-- BOT√ÉO NOVO VE√çCULO -->
      {% if ROLE_ADMIN %}
      <button type="button" onclick="document.getElementById('modalNovoVeiculo').showModal()"
              class="px-5 py-2 bg-green-600 hover:bg-green-500 rounded-xl text-white font-semibold shadow-lg whitespace-nowrap">
          <i class="fa-solid fa-plus mr-1"></i> Novo
      </button>
      {% endif %}
  </div>
</div>

<!-- ===============================
      GRID DE CARDS (4 POR LINHA)
================================ -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">

{% for v in veiculos %}
{% set tipo = (v.type or 'carro')|lower %}

{% if tipo == 'caminhao' %}
    {% set bg = 'bg-orange-900/40 border-orange-700/60 hover:bg-orange-900/50' %}
    {% set icon = 'fa-truck text-orange-300' %}
{% elif tipo == 'moto' %}
    {% set bg = 'bg-yellow-900/40 border-yellow-700/60 hover:bg-yellow-900/50' %}
    {% set icon = 'fa-motorcycle text-yellow-300' %}
{% elif tipo == 'van' %}
    {% set bg = 'bg-teal-900/40 border-teal-700/60 hover:bg-teal-900/50' %}
    {% set icon = 'fa-van-shuttle text-teal-300' %}
{% else %}
    {% set bg = 'bg-blue-900/40 border-blue-700/60 hover:bg-blue-900/50' %}
    {% set icon = 'fa-car text-blue-300' %}
{% endif %}

{% set status = (v.status or '').strip().upper() %}
{% set info = v.info %}

<!-- ========================
        CARD PREMIUM ULTRA
========================= -->
<div class="group relative rounded-2xl border {{ bg }} shadow-xl p-5 
            overflow-hidden transition-all duration-300 
            hover:scale-[1.04] hover:shadow-blue-900/40 hover:-translate-y-1 
            backdrop-blur-xl bg-opacity-40 border-opacity-40">

    <!-- BARRA LATERAL COLORIDA -->
    <div class="absolute left-0 top-0 h-full w-1.5 
                {% if tipo == 'caminhao' %} bg-orange-400 
                {% elif tipo == 'moto' %} bg-yellow-400 
                {% elif tipo == 'van' %} bg-teal-400 
                {% else %} bg-blue-400 {% endif %}">
    </div>

    <!-- √çCONE GIGANTE NO FUNDO -->
    <i class="fa-solid {{ icon }} absolute right-3 bottom-2 text-7xl opacity-[0.07]"></i>

    <!-- T√çTULO (PLACA MERCOSUL) + STATUS -->
    <div class="flex justify-between items-start mb-4">

        <!-- PLACA MERCOSUL -->
        <div class="select-none">
            <!-- Faixa superior -->
            <div class="relative bg-blue-700 text-white w-36 rounded-t-md border border-blue-900 shadow">
                <div class="flex items-center justify-between px-2 py-0.5">
                    <svg width="22" height="10" viewBox="0 0 22 14" fill="none">
                        <circle cx="3" cy="7" r="1" fill="white"/>
                        <circle cx="7" cy="5" r="1" fill="white"/>
                        <circle cx="11" cy="6.5" r="1" fill="white"/>
                        <circle cx="15" cy="4.5" r="1" fill="white"/>
                        <circle cx="19" cy="7" r="1" fill="white"/>
                    </svg>
                    <span class="text-[10px] font-bold tracking-wide">BRASIL</span>
                    <div class="w-5 h-3 bg-green-600 relative flex items-center justify-center border border-white">
                        <div class="w-3 h-3 bg-yellow-400 rotate-45 absolute"></div>
                        <div class="w-2 h-2 bg-blue-700 rounded-full absolute"></div>
                    </div>
                </div>
            </div>

            <!-- Campo da placa -->
            <div class="bg-white text-black font-extrabold text-lg 
                        px-3 py-1 tracking-[0.12em] shadow-md 
                        border border-gray-400 rounded-b-md text-center font-mono">
                {{ v.plate }}
            </div>
        </div>

        <!-- STATUS -->
        <span class="px-3 py-1 rounded-lg text-xs font-semibold border shadow-sm
            {% if status == 'ATIVO' %}
                bg-green-800/60 text-green-200 border-green-600/40
            {% elif status == 'INATIVO' %}
                bg-red-800/60 text-red-200 border-red-600/40
            {% elif status in ['MANUTENCAO','MANUTEN√á√ÉO'] %}
                bg-yellow-800/60 text-yellow-200 border-yellow-600/40
            {% else %}
                bg-gray-700/60 text-gray-300 border-gray-500/40
            {% endif %}">
            {{ v.status }}
        </span>
    </div>

    <div class="border-t border-white/10 mb-4"></div>

    <!-- TABELA DE INFORMA√á√ïES -->
    <div class="text-sm text-gray-200 space-y-1.5">

        <div class="flex justify-between">
            <span class="text-gray-400 flex items-center gap-2">
                <i class="fa-solid fa-tag text-gray-500"></i> Marca:
            </span>
            <span class="font-medium">{{ v.brand or '-' }}</span>
        </div>

        <div class="flex justify-between">
            <span class="text-gray-400 flex items-center gap-2">
                <i class="fa-solid fa-car-side text-gray-500"></i> Modelo:
            </span>
            <span class="font-medium">{{ v.model or '-' }}</span>
        </div>

        <div class="flex justify-between">
            <span class="text-gray-400 flex items-center gap-2">
                <i class="fa-solid fa-calendar text-gray-500"></i> Ano:
            </span>
            <span class="font-medium">{{ v.year or '-' }}</span>
        </div>

        <div class="flex justify-between">
            <span class="text-gray-400 flex items-center gap-2">
                <i class="fa-solid fa-road text-gray-500"></i> KM:
            </span>
            <span class="font-medium">{{ v.km or 0 }}</span>
        </div>

        <div class="flex justify-between">
            <span class="text-gray-400 flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-gray-500"></i> Tipo:
            </span>
            <span class="font-medium capitalize">
                {{ v.type or 'N√£o definido' }}
            </span>
        </div>

    </div>

    <!-- BOT√ïES (lado a lado, sem estourar card) -->
    {% if ROLE_ADMIN %}
    <div class="mt-5 border-t border-white/10 pt-4">

      <div class="flex gap-2">
        <button type="button"
                onclick="document.getElementById('info{{ v.id }}').showModal()"
                class="w-1/2 px-2 py-1.5 text-xs bg-gray-700 hover:bg-gray-600 rounded-lg 
                       text-white shadow font-semibold transition-all duration-150">
            Ver info
        </button>

        <button type="button"
                onclick="document.getElementById('edit{{ v.id }}').showModal()"
                class="w-1/2 px-2 py-1.5 text-xs bg-blue-600 hover:bg-blue-500 rounded-lg 
                       text-white shadow font-semibold transition-all duration-150">
            Editar
        </button>
      </div>

      <form class="mt-2" method="post" action="{{ url_for('vehicle_delete', vid=v.id) }}"
            onsubmit="return confirm('Excluir ve√≠culo {{ v.plate }}?');">
        <button class="w-full px-2 py-1.5 text-xs bg-red-700 hover:bg-red-600 rounded-lg text-white shadow font-semibold">
          Excluir
        </button>
      </form>

    </div>
    {% endif %}
</div>

<!-- ===============================
      MODAL: INFORMA√á√ïES (VISUALIZAR)
================================ -->
<dialog id="info{{ v.id }}"
        class="rounded-2xl bg-gray-900 border border-gray-700 p-6 shadow-2xl w-[540px]">

  <div class="flex items-start justify-between gap-3">
    <div>
      <h2 class="text-xl font-bold text-white">Informa√ß√µes ‚Äî {{ v.plate }}</h2>
      <p class="text-xs text-gray-400 mt-1">
        {{ v.brand or '-' }} ¬∑ {{ v.model or '-' }} ¬∑ {{ v.year or '-' }}
      </p>
    </div>

    <button type="button"
            onclick="document.getElementById('info{{ v.id }}').close()"
            class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded-lg text-gray-200">
      Fechar
    </button>
  </div>

  <div class="border-t border-white/10 my-4"></div>

  <div class="space-y-2 text-sm text-gray-200">

    <div class="flex justify-between">
      <span class="text-gray-400">√ìleo (tipo)</span>
      <span class="font-medium">{{ info.oil_type if info else '-' }}</span>
    </div>

    <div class="flex justify-between">
      <span class="text-gray-400">√ìleo (marca)</span>
      <span class="font-medium">{{ info.oil_brand if info else '-' }}</span>
    </div>

    <div class="flex justify-between">
      <span class="text-gray-400">Capacidade (L)</span>
      <span class="font-medium">
        {% if info and info.oil_capacity_l is not none %}{{ info.oil_capacity_l }}{% else %}-{% endif %}
      </span>
    </div>

    <div class="flex justify-between">
      <span class="text-gray-400">Filtro de √≥leo</span>
      <span class="font-medium">{{ info.filter_oil if info else '-' }}</span>
    </div>

    <div class="flex justify-between">
      <span class="text-gray-400">Filtro de ar</span>
      <span class="font-medium">{{ info.filter_air if info else '-' }}</span>
    </div>

    <div class="flex justify-between">
      <span class="text-gray-400">Filtro combust√≠vel</span>
      <span class="font-medium">{{ info.filter_fuel if info else '-' }}</span>
    </div>

    <div class="flex justify-between">
      <span class="text-gray-400">Arrefecimento</span>
      <span class="font-medium">{{ info.coolant_type if info else '-' }}</span>
    </div>

    <div class="flex justify-between">
      <span class="text-gray-400">Fluido de freio</span>
      <span class="font-medium">{{ info.brake_fluid if info else '-' }}</span>
    </div>

    <div class="flex justify-between">
      <span class="text-gray-400">Press√£o pneus</span>
      <span class="font-medium">{{ info.tire_pressure if info else '-' }}</span>
    </div>

    <div>
      <div class="text-gray-400 mb-1">Observa√ß√µes</div>
      <div class="bg-gray-800/60 border border-white/10 rounded-xl p-3 text-gray-200 min-h-[60px]">
        {{ info.notes if info and info.notes else '-' }}
      </div>
    </div>

    {% if info and info.updated_at %}
      <p class="text-xs text-gray-500 mt-2">
        Atualizado em: {{ info.updated_at.strftime('%d/%m/%Y %H:%M') }}
      </p>
    {% endif %}

  </div>

  {% if ROLE_ADMIN %}
  <div class="mt-5 flex justify-end gap-3">
    <button type="button"
            onclick="
              document.getElementById('info{{ v.id }}').close();
              document.getElementById('infoEdit{{ v.id }}').showModal();
            "
            class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-semibold">
      Cadastrar / Editar informa√ß√µes
    </button>
  </div>
  {% endif %}

</dialog>

<!-- ===============================
      MODAL: CADASTRAR/EDITAR INFORMA√á√ïES
================================ -->
<dialog id="infoEdit{{ v.id }}"
        class="rounded-2xl bg-gray-900 border border-gray-700 p-6 shadow-2xl w-[600px]">

  <div class="flex items-start justify-between gap-3">
    <div>
      <h2 class="text-xl font-bold text-white">Cadastro de informa√ß√µes ‚Äî {{ v.plate }}</h2>
      <p class="text-xs text-gray-400 mt-1">√ìtimo para manter padr√£o de √≥leo, filtros e dados preventivos.</p>
    </div>

    <button type="button"
            onclick="document.getElementById('infoEdit{{ v.id }}').close()"
            class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 rounded-lg text-gray-200">
      Fechar
    </button>
  </div>

  <div class="border-t border-white/10 my-4"></div>

  <form method="post" action="{{ url_for('vehicle_info_save', vid=v.id) }}" class="space-y-4">

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="text-sm text-gray-300">√ìleo (tipo)</label>
        <input name="oil_type" value="{{ info.oil_type if info else '' }}"
               placeholder="Ex: 5W30"
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>

      <div>
        <label class="text-sm text-gray-300">√ìleo (marca)</label>
        <input name="oil_brand" value="{{ info.oil_brand if info else '' }}"
               placeholder="Ex: Mobil, Castrol..."
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="text-sm text-gray-300">Capacidade (L)</label>
        <input type="number" step="0.1" name="oil_capacity_l"
               value="{{ info.oil_capacity_l if info and info.oil_capacity_l is not none else '' }}"
               placeholder="Ex: 3.5"
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>

      <div>
        <label class="text-sm text-gray-300">Press√£o pneus</label>
        <input name="tire_pressure" value="{{ info.tire_pressure if info else '' }}"
               placeholder="Ex: 32psi / 30psi"
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>
    </div>

    <div class="grid grid-cols-3 gap-3">
      <div>
        <label class="text-sm text-gray-300">Filtro de √≥leo</label>
        <input name="filter_oil" value="{{ info.filter_oil if info else '' }}"
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>

      <div>
        <label class="text-sm text-gray-300">Filtro de ar</label>
        <input name="filter_air" value="{{ info.filter_air if info else '' }}"
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>

      <div>
        <label class="text-sm text-gray-300">Filtro combust√≠vel</label>
        <input name="filter_fuel" value="{{ info.filter_fuel if info else '' }}"
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="text-sm text-gray-300">Flu√≠do de arrefecimento</label>
        <input name="coolant_type" value="{{ info.coolant_type if info else '' }}"
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>

      <div>
        <label class="text-sm text-gray-300">Flu√≠do de freio</label>
        <input name="brake_fluid" value="{{ info.brake_fluid if info else '' }}"
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>
    </div>

    <div>
      <label class="text-sm text-gray-300">Observa√ß√µes</label>
      <textarea name="notes" rows="3"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white"
                placeholder="Ex: troca de √≥leo a cada 8.000km...">{{ info.notes if info and info.notes else '' }}</textarea>
    </div>

    <div class="flex justify-end gap-3 pt-3">
      <button type="button"
              onclick="
                document.getElementById('infoEdit{{ v.id }}').close();
                document.getElementById('info{{ v.id }}').showModal();
              "
              class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white">
        Voltar
      </button>

      <button class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-semibold">
        Salvar informa√ß√µes
      </button>
    </div>

  </form>
</dialog>

<!-- ===============================
      MODAL DE EDI√á√ÉO DO VE√çCULO (ORIGINAL)
================================ -->
<dialog id="edit{{ v.id }}"
        class="rounded-2xl bg-gray-900 border border-gray-700 p-6 shadow-2xl w-[430px]">

  <h2 class="text-xl font-bold mb-4 text-white">
    Editar ve√≠culo ‚Äî {{ v.plate }}
  </h2>

  <form method="post" action="{{ url_for('vehicle_edit', vid=v.id) }}" class="space-y-4">

    <div>
      <label class="text-sm text-gray-300">Marca</label>
      <input name="brand" value="{{ v.brand }}"
             class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
    </div>

    <div>
      <label class="text-sm text-gray-300">Modelo</label>
      <input name="model" value="{{ v.model }}"
             class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="text-sm text-gray-300">Ano</label>
        <input type="number" name="year" value="{{ v.year }}"
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>

      <div>
        <label class="text-sm text-gray-300">KM</label>
        <input type="number" name="km" value="{{ v.km }}"
               class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
      </div>
    </div>

    <div>
      <label class="text-sm text-gray-300">Tipo</label>
      <select name="type"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
        <option value="carro" {% if tipo=='carro' %}selected{% endif %}>Carro</option>
        <option value="moto" {% if tipo=='moto' %}selected{% endif %}>Moto</option>
        <option value="caminhao" {% if tipo=='caminhao' %}selected{% endif %}>Caminh√£o</option>
        <option value="van" {% if tipo=='van' %}selected{% endif %}>Van</option>
      </select>
    </div>

    <div>
      <label class="text-sm text-gray-300">Status</label>
      <select name="status"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
        <option value="ATIVO" {% if status=='ATIVO' %}selected{% endif %}>ATIVO</option>
        <option value="MANUTENCAO" {% if status in ['MANUTENCAO','MANUTEN√á√ÉO'] %}selected{% endif %}>MANUTEN√á√ÉO</option>
        <option value="INATIVO" {% if status=='INATIVO' %}selected{% endif %}>INATIVO</option>
      </select>
    </div>

    <div class="flex justify-end gap-3 pt-3">
      <button type="button"
              onclick="document.getElementById('edit{{ v.id }}').close()"
              class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white">
        Cancelar
      </button>

      <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold">
        Salvar
      </button>
    </div>

  </form>
</dialog>

{% endfor %}
</div>

<!-- ===============================
      MODAL NOVO VE√çCULO
================================ -->
<dialog id="modalNovoVeiculo"
        class="rounded-2xl bg-gray-900 border border-gray-700 p-6 shadow-2xl w-[420px]">

  <h2 class="text-xl font-bold text-white mb-4">Cadastrar novo ve√≠culo</h2>

  <form method="post" action="{{ url_for('vehicle_new') }}" class="space-y-4">

    <div>
      <label class="text-sm text-gray-300">Placa</label>
      <input name="plate" required
             class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
    </div>

    <div>
      <label class="text-sm text-gray-300">Marca</label>
      <input name="brand"
             class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
    </div>

    <div>
      <label class="text-sm text-gray-300">Modelo</label>
      <input name="model"
             class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
    </div>

    <div>
      <label class="text-sm text-gray-300">Ano</label>
      <input type="number" name="year"
             class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
    </div>

    <div>
      <label class="text-sm text-gray-300">KM inicial</label>
      <input type="number" name="km" value="0"
             class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
    </div>

    <div>
      <label class="text-sm text-gray-300">Tipo</label>
      <select name="type"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
        <option value="carro">Carro</option>
        <option value="moto">Moto</option>
        <option value="caminhao">Caminh√£o</option>
        <option value="van">Van</option>
      </select>
    </div>

    <div>
      <label class="text-sm text-gray-300">Status</label>
      <select name="status"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
        <option value="ATIVO">ATIVO</option>
        <option value="MANUTENCAO">MANUTEN√á√ÉO</option>
        <option value="INATIVO">INATIVO</option>
      </select>
    </div>

    <div class="flex justify-end gap-3 pt-3">
      <button type="button"
              onclick="document.getElementById('modalNovoVeiculo').close()"
              class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white">
        Cancelar
      </button>

      <button class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-semibold">
        Cadastrar
      </button>
    </div>

  </form>
</dialog>

<script>
  // ‚úÖ Fecha todos os <dialog> ao clicar fora (no backdrop)
  (function () {
    const dialogs = document.querySelectorAll('dialog');
    dialogs.forEach(dlg => {
      dlg.addEventListener('click', (e) => {
        const rect = dlg.getBoundingClientRect();
        const clicouNoFundo =
          e.clientX < rect.left || e.clientX > rect.right ||
          e.clientY < rect.top  || e.clientY > rect.bottom;

        if (clicouNoFundo) dlg.close();
      });
    });
  })();
</script>

{% endblock %}
