{% extends 'layout.html' %}
{% set page_title = "Detalhe da vistoria" %}
{% block content %}

<div class="bg-white/70 border border-slate-900/10 rounded-2xl shadow p-5 backdrop-blur
            dark:bg-white/5 dark:border-white/10">

  <!-- Cabeçalho -->
  <div class="flex flex-wrap items-start justify-between gap-3">
    <div>
      <h2 class="text-xl font-bold text-slate-900 dark:text-white">Vistoria #{{ v.id }}</h2>

      <p class="text-sm text-slate-600 mt-1 dark:text-gray-300">
        {{ v.created_at.strftime('%d/%m/%Y %H:%M') }}
        · Placa: <span class="font-semibold text-slate-900 dark:text-white">{{ v.vehicle.plate }}</span>
        · KM: <span class="text-slate-900/90 dark:text-gray-200">{{ v.km or '-' }}</span>
      </p>

      <p class="text-xs text-slate-500 mt-1 dark:text-gray-400">
        Turno: {{ v.turno }}{% if v.local %} · Local: {{ v.local }}{% endif %}
      </p>
    </div>

    <div class="flex items-center gap-2">
      {% if v.status_geral == 'avarias' %}
        <span class="px-3 py-2 rounded-xl text-sm
                     bg-amber-500/10 text-amber-800 border border-amber-500/20
                     dark:bg-yellow-900/40 dark:text-yellow-200 dark:border-yellow-700/40">
          ⚠️ Com avarias
        </span>
      {% else %}
        <span class="px-3 py-2 rounded-xl text-sm
                     bg-emerald-600/10 text-emerald-800 border border-emerald-600/20
                     dark:bg-green-900/40 dark:text-green-200 dark:border-green-700/40">
          ✅ OK
        </span>
      {% endif %}
    </div>
  </div>

  {% if v.observacoes %}
    <div class="mt-4 bg-white/70 border border-slate-900/10 rounded-xl p-4
                dark:bg-white/5 dark:border-white/10">
      <p class="text-sm text-slate-700 whitespace-pre-wrap dark:text-gray-200">{{ v.observacoes }}</p>
    </div>
  {% endif %}

  <!-- Itens (2 colunas) -->
  {% set itens = [
    ('para_choque_dianteiro','Para-choque dianteiro'),
    ('para_choque_traseiro','Para-choque traseiro'),
    ('lateral_esquerda','Lateral esquerda'),
    ('lateral_direita','Lateral direita'),
    ('capo','Capô'),
    ('teto','Teto'),
    ('porta_malas','Porta-malas'),
    ('retrovisores','Retrovisores'),
    ('farois_lanternas','Faróis/Lanternas'),
    ('vidros_parabrisa','Vidros/Para-brisa'),
    ('pneus','Pneus'),
    ('calotas','Calotas')
  ] %}

  <div class="mt-6">
    <h3 class="text-lg font-semibold mb-3 text-slate-900 dark:text-white">Itens avaliados</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      {% for key, label in itens %}
        {% set val = v|attr(key) %}
        {% set obs = v|attr('obs_' ~ key) %}
        {% set fotos_item_objs = fotos_por_item.get(key, []) if fotos_por_item is defined else [] %}
        {% set fotos_item = fotos_item_objs|map(attribute='filename')|list %}

        <div class="bg-white/70 border border-slate-900/10 rounded-2xl px-4 py-3
                    dark:bg-white/5 dark:border-white/10">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-sm font-semibold text-slate-900 truncate dark:text-white">{{ label }}</p>
              <p class="text-xs text-slate-500 mt-0.5 dark:text-gray-500">
                {% if val == 'avaria' %}Detalhes disponíveis{% else %}Sem apontamentos{% endif %}
              </p>
            </div>

            <div class="shrink-0 flex items-center gap-2">
              {% if val == 'avaria' %}
                <span class="text-xs px-2 py-1 rounded-lg
                             bg-amber-500/10 text-amber-800 border border-amber-500/20
                             dark:bg-yellow-900/40 dark:text-yellow-200 dark:border-yellow-700/40">
                  ⚠️ Avaria
                </span>

                <!-- ✅ Abre modal (várias fotos) -->
                <button type="button"
                        class="px-3 py-1.5 rounded-lg text-xs
                               bg-slate-900/5 border border-slate-900/10 hover:bg-slate-900/10 transition
                               dark:bg-white/5 dark:border-white/10 dark:hover:bg-white/10"
                        data-open-modal="item"
                        data-label="{{ label|e }}"
                        data-obs="{{ (obs or '')|e }}"
                        data-fotos='{{ (fotos_item or [])|tojson }}'>
                  Ver detalhes
                </button>
              {% else %}
                <span class="text-xs px-2 py-1 rounded-lg
                             bg-emerald-600/10 text-emerald-800 border border-emerald-600/20
                             dark:bg-green-900/40 dark:text-green-200 dark:border-green-700/40">
                  ✅ OK
                </span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- (Opcional) Galeria geral -->
  {% if v.fotos and v.fotos|length > 0 %}
    <div class="mt-6">
      <h3 class="text-lg font-semibold mb-3 text-slate-900 dark:text-white">Galeria geral ({{ v.fotos|length }})</h3>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        {% for f in v.fotos %}
          <a href="{{ url_for('static', filename='vistorias_fotos/' ~ f.filename) }}" target="_blank"
             class="block overflow-hidden rounded-xl border border-slate-900/10 bg-white/70 hover:bg-white transition
                    dark:border-white/10 dark:bg-white/5 dark:hover:bg-white/10">
            <img src="{{ url_for('static', filename='vistorias_fotos/' ~ f.filename) }}"
                 class="w-full h-36 object-cover" alt="Foto">
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="mt-6 flex gap-3">
    <a href="{{ url_for('vistorias_list') }}"
       class="px-4 py-2 rounded-lg text-sm text-white
              bg-slate-600 hover:bg-slate-500
              dark:bg-gray-600 dark:hover:bg-gray-500">
      Voltar
    </a>
  </div>

</div>

<!-- ===========================
      ✅ MODAL (Detalhes item)
=========================== -->
<div id="itemModal" class="fixed inset-0 z-[60] hidden">
  <!-- overlay -->
  <div id="itemModalOverlay" class="absolute inset-0 bg-black/70"></div>

  <!-- modal box -->
  <div class="relative min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-3xl rounded-2xl border border-slate-900/10 bg-white/90 backdrop-blur-xl shadow-glass overflow-hidden
                dark:border-white/10 dark:bg-gray-950/90">

      <div class="flex items-start justify-between gap-3 p-4 border-b border-slate-900/10 dark:border-white/10">
        <div class="min-w-0">
          <p class="text-xs text-slate-500 dark:text-gray-400">Detalhes do item</p>
          <h3 id="modalTitle" class="text-lg font-semibold text-slate-900 truncate dark:text-white">—</h3>
        </div>
        <button id="itemModalClose"
                type="button"
                class="px-3 py-2 rounded-lg text-sm
                       bg-slate-900/5 border border-slate-900/10 hover:bg-slate-900/10 transition
                       dark:bg-white/5 dark:border-white/10 dark:hover:bg-white/10"
                aria-label="Fechar">
          ✕
        </button>
      </div>

      <div class="p-4 space-y-4">
        <!-- Observação -->
        <div class="rounded-xl border border-slate-900/10 bg-white/70 p-4
                    dark:border-white/10 dark:bg-white/5">
          <p class="text-xs text-slate-700 font-semibold mb-2 dark:text-white/70">Observação</p>
          <p id="modalObs" class="text-sm text-slate-700 whitespace-pre-wrap dark:text-gray-200">—</p>
        </div>

        <!-- Fotos (várias) -->
        <div class="rounded-xl border border-slate-900/10 bg-white/70 p-4
                    dark:border-white/10 dark:bg-white/5">
          <p class="text-xs text-slate-700 font-semibold mb-3 dark:text-white/70">Fotos</p>

          <div id="modalFotosEmpty" class="text-sm text-slate-500 dark:text-gray-500">
            Nenhuma foto neste item.
          </div>

          <div id="modalFotosGrid" class="hidden grid grid-cols-2 md:grid-cols-3 gap-3"></div>
        </div>

        <div class="flex justify-end">
          <button id="itemModalClose2" type="button"
                  class="px-4 py-2 rounded-lg text-sm text-white transition
                         bg-slate-600 hover:bg-slate-500
                         dark:bg-gray-600 dark:hover:bg-gray-500">
            Fechar
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById("itemModal");
  const overlay = document.getElementById("itemModalOverlay");
  const closeBtn = document.getElementById("itemModalClose");
  const closeBtn2 = document.getElementById("itemModalClose2");

  const titleEl = document.getElementById("modalTitle");
  const obsEl = document.getElementById("modalObs");

  const emptyEl = document.getElementById("modalFotosEmpty");
  const gridEl = document.getElementById("modalFotosGrid");

  function safeParseJSON(str){
    try { return JSON.parse(str); } catch(e){ return []; }
  }

  function openModal({label, obs, fotosJson}){
    titleEl.textContent = label || "Item";
    obsEl.textContent = (obs && obs.trim()) ? obs : "Sem observação informada.";

    // limpa grid
    gridEl.innerHTML = "";

    const fotos = safeParseJSON(fotosJson || "[]");

    if(Array.isArray(fotos) && fotos.length > 0){
      emptyEl.classList.add("hidden");
      gridEl.classList.remove("hidden");

      fotos.forEach(filename => {
        if(!filename) return;
        const url = "/static/vistorias_fotos/" + String(filename).trim();

        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.className =
          "block overflow-hidden rounded-xl border border-slate-900/10 bg-slate-900/5 hover:bg-slate-900/10 transition " +
          "dark:border-white/10 dark:bg-black/10 dark:hover:bg-black/20";

        const img = document.createElement("img");
        img.src = url;
        img.alt = "Foto do item";
        img.className = "w-full h-36 object-cover";

        a.appendChild(img);
        gridEl.appendChild(a);
      });

    }else{
      gridEl.classList.add("hidden");
      emptyEl.classList.remove("hidden");
    }

    modal.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
  }

  function closeModal(){
    modal.classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
  }

  document.querySelectorAll("[data-open-modal='item']").forEach(btn => {
    btn.addEventListener("click", () => {
      openModal({
        label: btn.getAttribute("data-label") || "",
        obs: btn.getAttribute("data-obs") || "",
        fotosJson: btn.getAttribute("data-fotos") || "[]"
      });
    });
  });

  [overlay, closeBtn, closeBtn2].forEach(el => {
    if(!el) return;
    el.addEventListener("click", closeModal);
  });

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape" && !modal.classList.contains("hidden")){
      closeModal();
    }
  });
})();
</script>

{% endblock %}
