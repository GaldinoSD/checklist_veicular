<!doctype html>
<html lang="pt-BR" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ page_title or 'Sistema' }}</title>

    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon-v2.ico') }}">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- âœ… Tailwind config + dark mode -->
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            boxShadow: {
              glass: "0 18px 60px rgba(0,0,0,.45)",
            }
          }
        }
      }
    </script>

    <!-- âœ… Tema: aplica ANTES de renderizar (evita flash claro/escuro) -->
    <script>
      (function () {
        try {
          const saved = localStorage.getItem("theme"); // "dark" | "light" | null
          const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          const shouldDark = saved ? (saved === "dark") : prefersDark;

          if (shouldDark) document.documentElement.classList.add("dark");
          else document.documentElement.classList.remove("dark");
        } catch (e) {
          // se falhar, mantÃ©m padrÃ£o
        }
      })();
    </script>

    <style>
      /* âœ… NÃ£o coloque transition em tudo (pega input, table, etc). */
      a, button, .transit {
        transition: 0.15s ease-in-out;
      }

      /* =========================
         âœ… FUNDO PREMIUM - LIGHT/DARK
         - Camadas + noise leve
      ========================== */

      /* base */
      body {
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }

      /* LIGHT (padrÃ£o) */
      body {
        background: #f8fafc;
        color: #0f172a;
      }

      body::after {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -2;
        background:
          radial-gradient(ellipse at top, rgba(59,130,246,.10), transparent 55%),
          radial-gradient(ellipse at bottom, rgba(168,85,247,.08), transparent 60%),
          radial-gradient(ellipse at left, rgba(16,185,129,.06), transparent 55%),
          radial-gradient(ellipse at right, rgba(245,158,11,.05), transparent 55%);
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
        opacity: .05;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      }

      /* DARK (quando <html class="dark">) */
      .dark body {
        background: #020617;
        color: #f3f4f6;
      }

      .dark body::after {
        background:
          radial-gradient(ellipse at top, rgba(59,130,246,.18), transparent 55%),
          radial-gradient(ellipse at bottom, rgba(168,85,247,.14), transparent 60%),
          radial-gradient(ellipse at left, rgba(16,185,129,.10), transparent 55%),
          radial-gradient(ellipse at right, rgba(245,158,11,.08), transparent 55%);
      }

      .dark body::before {
        opacity: .06;
      }

      /* Vidro premium */
      .glass {
        background: rgba(255, 255, 255, 0.72);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }
      .dark .glass {
        background: rgba(255, 255, 255, 0.08);
      }

      /* ===== User chip premium ===== */
      .userchip {
        background: rgba(15, 23, 42, 0.05);
        border: 1px solid rgba(15, 23, 42, 0.10);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }
      .dark .userchip {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
      }

      .userchip:hover {
        background: rgba(15, 23, 42, 0.07);
        border-color: rgba(15, 23, 42, 0.14);
      }
      .dark .userchip:hover {
        background: rgba(255,255,255,0.085);
        border-color: rgba(255,255,255,0.18);
      }

      .userchip-name {
        background: linear-gradient(90deg, #0f172a, #2563eb);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .dark .userchip-name {
        background: linear-gradient(90deg, #ffffff, #9ecbff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .userchip-dot {
        box-shadow: 0 0 0 2px rgba(255,255,255,.55);
      }
      .dark .userchip-dot {
        box-shadow: 0 0 0 2px rgba(0,0,0,.25);
      }

      .userchip-glow-admin {
        box-shadow: 0 0 0 1px rgba(250,204,21,.25), 0 0 14px rgba(250,204,21,.35);
      }
      .userchip-glow-default {
        box-shadow: 0 0 0 1px rgba(59,130,246,.22), 0 0 12px rgba(59,130,246,.28);
      }

      /* âœ… BotÃ£o tema */
      .themebtn {
        border: 1px solid rgba(15,23,42,.12);
        background: rgba(255,255,255,.55);
      }
      .themebtn:hover {
        background: rgba(255,255,255,.75);
      }
      .dark .themebtn {
        border: 1px solid rgba(255,255,255,.15);
        background: rgba(255,255,255,.06);
      }
      .dark .themebtn:hover {
        background: rgba(255,255,255,.10);
      }
    </style>
  </head>

  <body class="min-h-screen">

    <!-- ============================
          CABEÃ‡ALHO MODERNO PREMIUM
    ============================== -->
    <header class="glass border-b border-slate-900/10 dark:border-white/20 sticky top-0 z-50 shadow-glass">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-2 flex items-center justify-between gap-3">

        <!-- LOGO (NÃƒO CLICÃVEL) + TOOLTIP (versÃ£o e dev) -->
        <div class="relative group flex items-center gap-3 shrink-0 cursor-default select-none">
          <img src="{{ url_for('static', filename='logo.png') }}"
               class="h-7 w-auto object-contain drop-shadow"
               alt="Logo do sistema">

          <!-- Tooltip -->
          <div
            class="absolute top-full left-0 mt-2 w-max max-w-xs
                   opacity-0 translate-y-1 scale-95
                   group-hover:opacity-100 group-hover:translate-y-0 group-hover:scale-100
                   pointer-events-none
                   transition-all duration-200 ease-out
                   z-50">

            <div class="glass border border-slate-900/10 dark:border-white/20 rounded-xl px-3 py-2 shadow-glass">
              <div class="text-[11px] font-semibold text-slate-900 dark:text-white tracking-wide">
                Sistema de Controle Veicular
              </div>

              <div class="mt-1 text-[10px] text-slate-600 dark:text-gray-300">
                VersÃ£o <span class="font-semibold text-blue-600 dark:text-blue-300">v1.1.0</span>
              </div>

              <div class="text-[10px] text-slate-500 dark:text-gray-400">
                Desenvolvido por <span class="text-slate-800 dark:text-gray-200 font-medium">Jonatas de A. Galdino</span>
              </div>
            </div>
          </div>
        </div>

        {% if current_user.is_authenticated and (ROLE_ADMIN or ROLE_SUPERVISOR) %}

        {% set menu_items = [
          ('Dashboard', 'dashboard'),
          ('VeÃ­culos', 'vehicles'),
          ('Checklists', 'checklists'),
          ('Vistoria', 'vistorias_list'),
          ('Entrada / SaÃ­da', 'controle_veiculos'),
          ('RelatÃ³rios', 'reports'),
          ('Avarias / O.S.', 'avarias_registro')
        ] %}

        <!-- MENU DESKTOP (mais compacto) -->
        <nav class="hidden md:flex items-center gap-1 text-[12px] font-medium mx-auto px-1.5">
          {% for label, route in menu_items %}
            {% set is_active = (request.endpoint == route) %}
            <a href="{{ url_for(route) }}"
               class="px-2.5 py-1 rounded-md font-medium tracking-wide border border-transparent text-[12px]
                      {% if is_active %}
                        bg-blue-600/20 text-slate-900 dark:text-white border-blue-500/25
                      {% else %}
                        text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/5 hover:border-slate-900/10 dark:hover:border-white/10
                      {% endif %}">
              {{ label }}
            </a>
          {% endfor %}

          {% if ROLE_ADMIN %}
            <span class="w-px h-5 bg-slate-900/10 dark:bg-white/15 mx-1.5"></span>

            {% set is_users = (request.endpoint == 'users') %}
            <a href="{{ url_for('users') }}"
               class="px-2.5 py-1 rounded-md border border-transparent text-[12px]
                      {% if is_users %}
                        bg-blue-600/20 text-slate-900 dark:text-white border-blue-500/25
                      {% else %}
                        text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/5 hover:border-slate-900/10 dark:hover:border-white/10
                      {% endif %}">
              UsuÃ¡rios
            </a>

            {% set is_cfg = (request.endpoint == 'config_checklist') %}
            <a href="{{ url_for('config_checklist') }}"
               class="px-2.5 py-1 rounded-md border border-transparent text-[12px]
                      {% if is_cfg %}
                        bg-blue-600/20 text-slate-900 dark:text-white border-blue-500/25
                      {% else %}
                        text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/5 hover:border-slate-900/10 dark:hover:border-white/10
                      {% endif %}">
              ConfiguraÃ§Ãµes
            </a>

            {% set is_logs = (request.endpoint == 'logs') %}
            <a href="{{ url_for('logs') }}"
               class="px-2.5 py-1 rounded-md border border-transparent text-[12px]
                      {% if is_logs %}
                        bg-yellow-600/15 text-slate-900 dark:text-white border-yellow-500/25
                      {% else %}
                        text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white hover:bg-black/5 dark:hover:bg-yellow-600/10 hover:border-slate-900/10 dark:hover:border-yellow-500/20
                      {% endif %}">
              Logs
            </a>
          {% endif %}
        </nav>

        <!-- BOTÃƒO MOBILE (HAMBURGUER) -->
        <button type="button"
                id="btnMobileMenu"
                class="md:hidden px-3 py-2 rounded-lg border border-slate-900/10 dark:border-white/15 bg-white/60 dark:bg-white/5 hover:bg-white/80 dark:hover:bg-white/10 transit text-sm text-slate-800 dark:text-gray-100"
                aria-expanded="false"
                aria-controls="mobileMenu">
          â˜°
        </button>

        {% endif %}

        <!-- PERFIL + TEMA + SAIR -->
        <div class="flex items-center gap-2.5 shrink-0">
          {% if current_user.is_authenticated %}

            <!-- âœ… BotÃ£o tema (sempre visÃ­vel) -->
            <button type="button"
                    id="btnTheme"
                    class="themebtn px-3 py-2 rounded-xl text-sm transit text-slate-800 dark:text-gray-100"
                    title="Alternar tema">
              <span id="themeIcon">ðŸŒ™</span>
            </button>

            {% set role_label = 'TÃ©cnico' %}
            {% if request.endpoint in ['checklist_mobile', 'manutencao_os'] %}
              {% set role_label = 'Colaborador' %}
            {% else %}
              {% if ROLE_ADMIN %}
                {% set role_label = 'Administrador' %}
              {% elif ROLE_SUPERVISOR %}
                {% set role_label = 'Supervisor' %}
              {% endif %}
            {% endif %}

            <!-- CHIP PREMIUM COM SAIR DENTRO -->
            <div class="hidden sm:flex items-center gap-2.5 pl-2 pr-2 py-1 rounded-2xl userchip transit">

              <!-- avatar -->
              <div class="w-8 h-8 rounded-xl flex items-center justify-center font-extrabold shadow text-sm
                {% if ROLE_ADMIN %}
                  bg-gradient-to-br from-yellow-400 to-yellow-300 text-black userchip-glow-admin
                {% else %}
                  bg-gradient-to-br from-blue-700 to-blue-500 text-white userchip-glow-default
                {% endif %}">
                {{ current_user.username[0] | upper }}
              </div>

              <!-- nome + papel -->
              <div class="leading-tight min-w-0">
                <div class="text-[13px] font-extrabold userchip-name max-w-[130px] truncate">
                  {{ current_user.username }}
                </div>

                <div class="flex items-center gap-1.5 mt-0.5 text-[10px] text-slate-600 dark:text-gray-300">
                  <span class="w-2 h-2 rounded-full bg-emerald-400 userchip-dot"></span>

                  <span class="px-1.5 py-0.5 rounded-full border border-slate-900/10 dark:border-white/10 bg-white/50 dark:bg-white/5 whitespace-nowrap">
                    {{ role_label }}
                  </span>

                  {% if ROLE_ADMIN %}
                    <span class="text-yellow-500 dark:text-yellow-300">ðŸ‘‘</span>
                  {% endif %}
                </div>
              </div>

              <span class="w-px h-6 bg-slate-900/10 dark:bg-white/10 mx-1"></span>

              <a href="{{ url_for('logout') }}"
                 class="px-2.5 py-1 rounded-lg text-[11px] font-semibold
                        bg-red-600/15 dark:bg-red-600/20 border border-red-600/25 dark:border-red-600/30 text-red-700 dark:text-red-100
                        hover:bg-red-600/20 dark:hover:bg-red-600/30 hover:border-red-500/30 dark:hover:border-red-500/40 transit whitespace-nowrap">
                Sair
              </a>
            </div>

            <!-- Mobile: mantÃ©m sÃ³ botÃ£o sair -->
            <a href="{{ url_for('logout') }}"
               class="sm:hidden px-3 py-1.5 rounded-xl text-sm bg-red-600/15 dark:bg-red-600/25 border border-red-600/25 dark:border-red-600/35
                      hover:bg-red-600/20 dark:hover:bg-red-600/35 hover:text-red-700 dark:hover:text-red-100 transit text-red-700 dark:text-red-100">
              Sair
            </a>

          {% else %}
            <!-- na tela de login, vocÃª tambÃ©m pode mostrar o botÃ£o tema -->
            <button type="button"
                    id="btnTheme"
                    class="themebtn px-3 py-2 rounded-xl text-sm transit text-slate-800 dark:text-gray-100"
                    title="Alternar tema">
              <span id="themeIcon">ðŸŒ™</span>
            </button>

            <a href="{{ url_for('login') }}" class="text-sm text-slate-700 dark:text-gray-100 hover:text-blue-600 dark:hover:text-blue-400 transit">
              Login
            </a>
          {% endif %}
        </div>

      </div>

      <!-- MENU MOBILE (dropdown) -->
      {% if current_user.is_authenticated and (ROLE_ADMIN or ROLE_SUPERVISOR) %}
      <div id="mobileMenu" class="md:hidden hidden border-t border-slate-900/10 dark:border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex flex-col gap-2">

          {% for label, route in menu_items %}
            {% set is_active = (request.endpoint == route) %}
            <a href="{{ url_for(route) }}"
               class="px-2.5 py-1.5 rounded-lg text-[12px] font-medium border border-transparent
                      {% if is_active %}
                        bg-blue-600/20 text-slate-900 dark:text-white border-blue-500/25
                      {% else %}
                        text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/5 hover:border-slate-900/10 dark:hover:border-white/10
                      {% endif %}">
              {{ label }}
            </a>
          {% endfor %}

          {% if ROLE_ADMIN %}
            <div class="h-px bg-slate-900/10 dark:bg-white/10 my-2"></div>

            <a href="{{ url_for('users') }}"
               class="px-2.5 py-1.5 rounded-lg text-[12px] font-medium border border-transparent
                      text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/5 hover:border-slate-900/10 dark:hover:border-white/10">
              UsuÃ¡rios
            </a>

            <a href="{{ url_for('config_checklist') }}"
               class="px-2.5 py-1.5 rounded-lg text-[12px] font-medium border border-transparent
                      text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/5 hover:border-slate-900/10 dark:hover:border-white/10">
              ConfiguraÃ§Ãµes
            </a>

            <a href="{{ url_for('logs') }}"
               class="px-2.5 py-1.5 rounded-lg text-[12px] font-medium border border-transparent
                      text-slate-600 dark:text-gray-300 hover:text-slate-900 dark:hover:text-white hover:bg-black/5 dark:hover:bg-yellow-600/10 hover:border-slate-900/10 dark:hover:border-yellow-500/20">
              Logs
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </header>

    <!-- ============================
          CONTEÃšDO PRINCIPAL
    ============================== -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6">

      {% with msgs = get_flashed_messages(with_categories=true) %}
        {% if msgs %}
          <div class="space-y-2 mb-4">
            {% for cat, msg in msgs %}
              <div class="px-4 py-2 rounded-lg text-sm border
                  {% if cat == 'success' %} bg-green-500/15 dark:bg-green-800/40 border-green-600/20 dark:border-green-600/40 text-green-800 dark:text-green-200
                  {% elif cat == 'error' %} bg-red-500/15 dark:bg-red-800/40 border-red-600/20 dark:border-red-600/40 text-red-800 dark:text-red-200
                  {% else %} bg-white/60 dark:bg-white/10 border-slate-900/10 dark:border-white/20 text-slate-800 dark:text-gray-100
                  {% endif %}">
                {{ msg }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>

    <script>
      // Mobile menu toggle (seguro mesmo se nÃ£o existir)
      (function () {
        const btn = document.getElementById("btnMobileMenu");
        const menu = document.getElementById("mobileMenu");
        if (!btn || !menu) return;

        btn.addEventListener("click", () => {
          const isOpen = !menu.classList.contains("hidden");
          menu.classList.toggle("hidden");
          btn.setAttribute("aria-expanded", String(!isOpen));
        });
      })();
    </script>

    <script>
      // âœ… Alternar tema + Ã­cone + persistÃªncia
      (function () {
        const btn = document.getElementById("btnTheme");
        const icon = document.getElementById("themeIcon");

        function isDark() {
          return document.documentElement.classList.contains("dark");
        }

        function syncIcon() {
          if (!icon) return;
          icon.textContent = isDark() ? "â˜€ï¸" : "ðŸŒ™";
        }

        function setTheme(next) {
          if (next === "dark") {
            document.documentElement.classList.add("dark");
            localStorage.setItem("theme", "dark");
          } else {
            document.documentElement.classList.remove("dark");
            localStorage.setItem("theme", "light");
          }
          syncIcon();
        }

        // Ã­cone inicial
        syncIcon();

        if (!btn) return;
        btn.addEventListener("click", () => {
          setTheme(isDark() ? "light" : "dark");
        });
      })();
    </script>
  </body>
</html>
