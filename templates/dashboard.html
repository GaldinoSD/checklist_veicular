{% extends 'layout.html' %}
{% set page_title = "Dashboard" %}
{% block content %}

<!-- ============================
      FILTRO DE PERÍODO + VEÍCULO
============================ -->
<form method="get"
      class="flex flex-wrap items-end gap-3
             bg-white/70 dark:bg-gray-800/40
             p-4 rounded-xl
             border border-slate-900/10 dark:border-gray-700
             mb-6">

  <!-- PERÍODO -->
  <div class="flex flex-col text-slate-700 dark:text-gray-300 text-xs">
    <label for="periodo">Período</label>
    <input id="periodo" type="text" name="periodo"
           value="{{ request.args.get('periodo', '') }}"
           placeholder="Selecione o período"
           class="bg-white dark:bg-gray-900
                  border border-slate-900/10 dark:border-gray-700
                  text-slate-900 dark:text-gray-200
                  placeholder:text-slate-400 dark:placeholder:text-gray-500
                  px-3 py-2 rounded-md w-64
                  focus:outline-none focus:ring-2 focus:ring-blue-500/40">
  </div>

  <!-- VEÍCULO -->
  <div class="flex flex-col text-slate-700 dark:text-gray-300 text-xs">
    <label for="veiculo">Veículo</label>
    <select id="veiculo" name="veiculo"
            class="bg-white dark:bg-gray-900
                   border border-slate-900/10 dark:border-gray-700
                   text-slate-900 dark:text-gray-200
                   px-3 py-2 rounded-md w-56
                   focus:outline-none focus:ring-2 focus:ring-blue-500/40">
      <option value="">Todos</option>

      {% for v in veiculos %}
        <option value="{{ v.id }}"
          {% if request.args.get('veiculo') == (v.id|string) %}
            selected
          {% endif %}
        >
          {{ v.plate }}
        </option>
      {% endfor %}
    </select>
  </div>

  <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
    Filtrar
  </button>

  <a href="{{ url_for('dashboard') }}"
     class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg text-sm">
    Limpar
  </a>
</form>


<!-- ============================
      CARDS SUPERIORES
============================ -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
  <div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow p-5">
    <p class="text-sm text-slate-600 dark:text-gray-300">Veículos</p>
    <p class="text-3xl font-bold mt-1 text-slate-900 dark:text-white">{{ total_veiculos }}</p>
  </div>

  <div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow p-5">
    <p class="text-sm text-slate-600 dark:text-gray-300">Checklists</p>
    <p class="text-3xl font-bold mt-1 text-slate-900 dark:text-white">{{ total_checklists }}</p>
  </div>

  <div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow p-5">
    <p class="text-sm text-slate-600 dark:text-gray-300">Relatórios</p>
    <p class="text-3xl font-bold mt-1 text-slate-900 dark:text-white">{{ total_relatorios }}</p>
  </div>

  <!-- ✅ ÚLTIMO RELATÓRIO -->
  <div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow p-5">
    <p class="text-sm text-slate-600 dark:text-gray-300">Último relatório</p>
    <p class="text-lg font-semibold mt-1 break-all text-slate-900 dark:text-white">
      {% if ultimo_relatorio %}
        {{ ultimo_relatorio|br_datetime }}
      {% else %}
        -
      {% endif %}
    </p>
  </div>
</div>


<!-- ============================
      GRÁFICO + ALERTAS
============================ -->
<div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-4">

  <div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow p-5 lg:col-span-2">
    <h3 class="text-lg font-semibold mb-3 text-slate-900 dark:text-white">Quilometragem semanal</h3>
    <canvas id="kmWeekly"></canvas>
  </div>

  <div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow p-5">
    <h3 class="text-lg font-semibold mb-3 text-slate-900 dark:text-white">Alertas de revisão</h3>
    <p class="text-xs text-slate-500 dark:text-gray-400 mb-2">
      Intervalo: {{ rev_interval }} km · Aviso a {{ rev_margin }} km
    </p>

    <ul class="space-y-2 max-h-72 overflow-auto pr-2">
      {% for a in alerts %}
        <li class="p-3 rounded-xl
                   bg-yellow-200/60 dark:bg-yellow-900/30
                   text-yellow-900 dark:text-yellow-200
                   border border-yellow-500/25 dark:border-yellow-700/40">
          <div class="flex justify-between">
            <span class="font-semibold">{{ a.plate }}</span>
            <span class="text-xs">km: {{ a.km }}</span>
          </div>
          <p class="text-xs mt-1">
            Próx. revisão: {{ a.next_rev }} · Faltam {{ a.remaining }} km
          </p>
        </li>
      {% else %}
        <li class="text-sm text-slate-500 dark:text-gray-400">Nenhum alerta.</li>
      {% endfor %}
    </ul>
  </div>

</div>


<!-- ============================
      CHECKLISTS RECENTES
============================ -->
<div class="mt-8 bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow">
  <div class="p-5 border-b border-slate-900/10 dark:border-white/10">
    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Checklists recentes</h3>
  </div>

  <div class="p-5 overflow-x-auto">
    <table class="min-w-full text-left text-sm">
      <thead>
        <tr class="text-slate-600 dark:text-gray-300">
          <th class="py-2 pr-4">Data</th>
          <th class="py-2 pr-4">Placa</th>
          <th class="py-2 pr-4">Técnico</th>
          <th class="py-2 pr-4">KM</th>
          <th class="py-2 pr-4">Status</th>
          <th class="py-2 pr-4">Detalhes</th>
        </tr>
      </thead>

      <tbody>
        {% for c in recentes %}
        <tr class="border-t border-slate-900/10 dark:border-white/10">
          <td class="py-2 pr-4 text-slate-900 dark:text-gray-100">{{ c.date|br_datetime }}</td>
          <td class="py-2 pr-4 text-slate-900 dark:text-gray-100">{{ c.vehicle.plate if c.vehicle else '-' }}</td>
          <td class="py-2 pr-4 text-slate-900 dark:text-gray-100">{{ c.technician or '-' }}</td>
          <td class="py-2 pr-4 text-slate-900 dark:text-gray-100">{{ c.km }}</td>
          <td class="py-2 pr-4">
            <span class="px-2 py-1 rounded-lg text-xs
                         bg-green-200/60 dark:bg-green-900/40
                         text-green-900 dark:text-green-200
                         border border-green-500/25 dark:border-green-700/40">
              {{ c.status }}
            </span>
          </td>
          <td class="py-2 pr-4">
            <a class="text-blue-700 dark:text-blue-400 underline" href="{{ url_for('checklist_detail', cid=c.id) }}">
              Ver
            </a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td class="py-3 text-slate-500 dark:text-gray-400" colspan="6">Sem registros.</td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>
</div>


<!-- ============================
      DASHBOARD DE AVARIAS
============================ -->
<div class="mt-10">
  <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-3">
    <i class="fa-solid fa-car-burst text-red-500"></i>
    Dashboard de Avarias
  </h2>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow p-5">
      <p class="text-sm text-slate-600 dark:text-gray-300">Total de Avarias</p>
      <p class="text-3xl font-bold mt-1 text-slate-900 dark:text-white">{{ total_avarias }}</p>
    </div>

    <div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow p-5">
      <p class="text-sm text-slate-600 dark:text-gray-300">Pendentes</p>
      <p class="text-3xl font-bold mt-1 text-yellow-600 dark:text-yellow-400">{{ avarias_pendentes }}</p>
    </div>

    <div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow p-5">
      <p class="text-sm text-slate-600 dark:text-gray-300">Finalizadas</p>
      <p class="text-3xl font-bold mt-1 text-green-600 dark:text-green-400">{{ avarias_finalizadas }}</p>
    </div>

    <div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow p-5">
      <p class="text-sm text-slate-600 dark:text-gray-300">Total gasto</p>
      <p class="text-3xl font-bold mt-1 text-red-600 dark:text-red-400">R$ {{ valor_total_gasto }}</p>
    </div>
  </div>

  <!-- LISTA -->
  <div class="mt-6 bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow">
    <div class="p-5 border-b border-slate-900/10 dark:border-white/10">
      <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Últimas avarias registradas</h3>
    </div>

    <div class="p-5 overflow-x-auto">
      <table class="min-w-full text-left text-sm">
        <thead>
          <tr class="text-slate-600 dark:text-gray-300">
            <th class="py-2 pr-4">ID</th>
            <th class="py-2 pr-4">Placa</th>
            <th class="py-2 pr-4">KM</th>
            <th class="py-2 pr-4">Gravidade</th>
            <th class="py-2 pr-4">Status</th>
            <th class="py-2 pr-4">Detalhes</th>
          </tr>
        </thead>

        <tbody>
          {% for a in recentes_avarias %}
          <tr class="border-t border-slate-900/10 dark:border-white/10">
            <td class="py-2 pr-4 text-slate-900 dark:text-gray-100">#{{ a.id }}</td>
            <td class="py-2 pr-4 text-slate-900 dark:text-gray-100">{{ a.vehicle.plate }}</td>
            <td class="py-2 pr-4 text-slate-900 dark:text-gray-100">{{ a.km }}</td>
            <td class="py-2 pr-4 text-slate-900 dark:text-gray-100 capitalize">{{ a.gravidade }}</td>
            <td class="py-2 pr-4">
              {% if a.status == 'aberta' %}
                <span class="px-2 py-1 rounded-lg text-xs
                             bg-yellow-200/60 dark:bg-yellow-900/40
                             text-yellow-900 dark:text-yellow-200
                             border border-yellow-500/25 dark:border-yellow-700/40">
                  Aberta
                </span>
              {% else %}
                <span class="px-2 py-1 rounded-lg text-xs
                             bg-green-200/60 dark:bg-green-900/40
                             text-green-900 dark:text-green-200
                             border border-green-500/25 dark:border-green-700/40">
                  Finalizada
                </span>
              {% endif %}
            </td>
            <td class="py-2 pr-4">
              <a class="text-blue-700 dark:text-blue-400 underline" href="{{ url_for('avarias_registro') }}">
                Ver
              </a>
            </td>
          </tr>
          {% else %}
          <tr>
            <td class="py-3 text-slate-500 dark:text-gray-400" colspan="6">Sem registros.</td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>
</div>


<!-- ============================
      GRÁFICO JS (acompanha o tema)
============================ -->
<script>
  const labels = {{ wk_labels | tojson }};
  const values = {{ wk_values | tojson }};
  const ctx = document.getElementById('kmWeekly').getContext('2d');

  function isDark() {
    return document.documentElement.classList.contains('dark');
  }

  function axisColor() {
    return isDark() ? '#cbd5e1' : '#334155';  // slate-300 / slate-700
  }

  function gridColor() {
    return isDark() ? 'rgba(148,163,184,.22)' : 'rgba(15,23,42,.10)'; // slate-400 / slate-900
  }

  function makeChart() {
    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'KM rodados por semana',
          data: values,
          backgroundColor: '#3b82f6'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            labels: { color: axisColor() }
          }
        },
        scales: {
          x: {
            ticks: { color: axisColor() },
            grid: { color: gridColor() }
          },
          y: {
            beginAtZero: true,
            ticks: { color: axisColor() },
            grid: { color: gridColor() }
          }
        }
      }
    });
  }

  let kmChart = makeChart();

  // ✅ atualiza cores quando o tema muda (botão no layout troca a classe "dark")
  const obs = new MutationObserver(() => {
    try {
      kmChart.destroy();
    } catch(e) {}
    kmChart = makeChart();
  });

  obs.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
</script>


<!-- ============================
      LITEPICKER (único)
============================ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>

<script>
  new Litepicker({
    element: document.getElementById('periodo'),
    singleMode: false,
    numberOfMonths: 2,
    numberOfColumns: 2,
    format: 'YYYY-MM-DD',
    delimiter: ' - ',
    autoApply: true
  });
</script>

{% endblock %}
