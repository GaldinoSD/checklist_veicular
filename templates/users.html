{% extends 'layout.html' %}
{% set page_title = "Usu√°rios" %}
{% block content %}

<!-- =======================================================
        HEADER
======================================================= -->
<div class="mb-8">
  <div class="flex flex-wrap items-start justify-between gap-4">
    <div>
      <h2 class="text-3xl md:text-4xl font-extrabold tracking-tight text-white">Colaboradores</h2>
      <p class="text-sm text-gray-300 mt-1">
        Gerencie usu√°rios, perfis e permiss√µes do sistema.
        <span class="text-gray-400">({{ items|length }} no total)</span>
      </p>
    </div>

    {% if ROLE_ADMIN %}
    <button
      onclick="document.getElementById('modalNovoUsuario').showModal()"
      class="group px-5 py-2.5 rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold shadow-lg
             flex items-center gap-2 transition focus:outline-none focus-visible:ring-2 focus-visible:ring-green-400/70">
      <span class="text-lg leading-none">Ôºã</span>
      <span>Novo colaborador</span>
      <span class="ml-1 opacity-60 group-hover:opacity-100 transition">‚Ä¢</span>
    </button>
    {% endif %}
  </div>
</div>


<!-- =======================================================
        GRID DE USU√ÅRIOS (at√© 3 por linha)
======================================================= -->
<div class="rounded-2xl bg-white/5 backdrop-blur-xl border border-white/10 shadow-[0_18px_60px_rgba(0,0,0,.35)] p-5">

  <!-- topo do grid -->
  <div class="flex flex-wrap items-center justify-between gap-3 mb-5">
    <div class="text-sm text-gray-300">
      Exibindo <span class="font-semibold text-white">{{ items|length }}</span> colaboradores
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">

    {% for u in items %}

    <!-- CARD -->
    <div class="relative rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition p-5 overflow-hidden
      {% if u.username == 'admin' %}
        ring-1 ring-yellow-400/50
      {% endif %}">

      <!-- glow decorativo -->
      <div class="absolute -top-20 -right-20 w-44 h-44 rounded-full blur-3xl opacity-20
        {% if u.username == 'admin' %}
          bg-yellow-400
        {% elif u.role == 'supervisor' %}
          bg-yellow-300
        {% elif u.role == 'manutencao' %}
          bg-purple-400
        {% elif u.role == 'admin' %}
          bg-blue-400
        {% else %}
          bg-gray-400
        {% endif %}">
      </div>

      <div class="relative flex items-start justify-between gap-3">
        <!-- esquerda -->
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-base font-extrabold shadow
            {% if u.username == 'admin' %}
              bg-gradient-to-br from-yellow-500 to-yellow-300 text-black
            {% else %}
              bg-gradient-to-br from-blue-700 to-blue-500 text-white
            {% endif %}">
            {{ u.username[0] | upper }}
          </div>

          <div class="min-w-0">
            <div class="flex items-center gap-2">
              <div class="text-white font-semibold truncate">{{ u.username }}</div>

              {% if u.username == 'admin' %}
                <span title="Administrador Principal" class="text-yellow-300 text-base drop-shadow">üëë</span>
                <span class="text-[10px] px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-200 border border-yellow-400/60">
                  Principal
                </span>
              {% endif %}
            </div>

            <div class="text-xs text-gray-400 mt-0.5">ID: {{ u.id }}</div>
          </div>
        </div>

        <!-- direita: badge -->
        <div class="shrink-0">
          <span class="text-[11px] px-2.5 py-1 rounded-full border w-fit font-semibold inline-flex items-center gap-2
            {% if u.username == 'admin' %}
              bg-yellow-500/20 text-yellow-200 border-yellow-400/60
            {% elif u.role == 'admin' %}
              bg-blue-900/40 text-blue-200 border-blue-700/40
            {% elif u.role == 'supervisor' %}
              bg-yellow-900/40 text-yellow-200 border-yellow-700/40
            {% elif u.role == 'manutencao' %}
              bg-purple-900/40 text-purple-200 border-purple-700/40
            {% else %}
              bg-gray-800/60 text-gray-200 border-gray-600/40
            {% endif %}">
            {% if u.username == "admin" %}
              Admin ‚Äî Principal
            {% elif u.role == "tech" %}
              T√©cnico
            {% else %}
              {{ u.role | capitalize }}
            {% endif %}
          </span>
        </div>
      </div>

      <!-- a√ß√µes -->
      <div class="relative flex items-center justify-end gap-2 mt-5">
        <button
          title="Editar"
          onclick="document.getElementById('modalEdit{{ u.id }}').showModal()"
          class="px-3 py-2 rounded-xl text-sm font-semibold shadow transition
            {% if u.username == 'admin' %}
              bg-yellow-500 hover:bg-yellow-400 text-black
            {% else %}
              bg-blue-600 hover:bg-blue-500 text-white
            {% endif %}
            focus:outline-none focus-visible:ring-2 focus-visible:ring-white/20">
          Editar
        </button>

        {% if u.username != 'admin' %}
        <form method="post" action="{{ url_for('users_del', uid=u.id) }}"
              onsubmit="return confirm('Deseja realmente excluir {{ u.username }}?');">
          <button
            title="Excluir"
            class="px-3 py-2 rounded-xl text-sm font-semibold shadow transition
                   bg-red-700 hover:bg-red-600 text-white
                   focus:outline-none focus-visible:ring-2 focus-visible:ring-red-300/40">
            Excluir
          </button>
        </form>
        {% endif %}
      </div>
    </div>


    <!-- =======================================================
            MODAL EDITAR
    ======================================================= -->
    <dialog id="modalEdit{{ u.id }}"
      class="rounded-2xl bg-gray-900 border border-gray-700 p-0 shadow-2xl w-[520px] max-w-[92vw] backdrop:bg-black/70">

      <div class="p-6 border-b border-white/10">
        <h2 class="text-xl font-bold text-white">Editar colaborador</h2>
        <p class="text-sm text-gray-400 mt-1">Atualize a senha e/ou perfil do usu√°rio.</p>
      </div>

      <div class="p-6">
        <form method="post" action="{{ url_for('users_pwd', uid=u.id) }}" class="space-y-4">

          <div>
            <label class="text-xs text-gray-400 font-medium">Usu√°rio</label>
            <input value="{{ u.username }}" disabled
              class="mt-1 w-full bg-gray-800/80 border border-gray-700 rounded-xl px-4 py-2.5 text-gray-400 text-sm shadow-inner">
          </div>

          <div>
            <label class="text-xs text-gray-400 font-medium">Nova senha</label>
            <input name="password" type="password" placeholder="Digite a nova senha"
              class="mt-1 w-full bg-gray-800/80 border border-gray-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner
                     focus:outline-none focus:ring-2 focus:ring-blue-500/40">
          </div>

          {% if u.username == "admin" %}
          <div>
            <label class="text-xs text-red-400 font-medium">Senha mestre</label>
            <input name="master_key" type="password" placeholder="Obrigat√≥ria para editar admin"
              class="mt-1 w-full bg-red-900/30 border border-red-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner
                     focus:outline-none focus:ring-2 focus:ring-red-500/40">
          </div>
          {% endif %}

          {% if u.username != "admin" %}
          <div>
            <label class="text-xs text-gray-400 font-medium">Perfil</label>
            <select name="role" form="formRole{{ u.id }}"
              class="mt-1 w-full bg-gray-800/80 border border-gray-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner
                     focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
              <option value="tech" {% if u.role == 'tech' %}selected{% endif %}>T√©cnico</option>
              <option value="supervisor" {% if u.role == 'supervisor' %}selected{% endif %}>Supervisor</option>
              <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>Administrador</option>
              <option value="manutencao" {% if u.role == 'manutencao' %}selected{% endif %}>Manuten√ß√£o</option>
            </select>
          </div>
          {% endif %}

          <div class="flex flex-wrap justify-end gap-3 pt-4">
            <button type="button"
              onclick="document.getElementById('modalEdit{{ u.id }}').close()"
              class="px-4 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-white text-sm
                     focus:outline-none focus-visible:ring-2 focus-visible:ring-white/20">
              Cancelar
            </button>

            <button formaction="{{ url_for('users_pwd', uid=u.id) }}"
              class="px-4 py-2 rounded-xl
                {% if u.username == 'admin' %}
                  bg-yellow-500 hover:bg-yellow-400 text-black
                {% else %}
                  bg-blue-600 hover:bg-blue-700 text-white
                {% endif %}
                text-sm font-semibold shadow
                focus:outline-none focus-visible:ring-2 focus-visible:ring-white/20">
              Salvar senha
            </button>

            {% if u.username != "admin" %}
            <button form="formRole{{ u.id }}"
              class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-semibold shadow
                     focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300/40">
              Atualizar perfil
            </button>
            {% endif %}
          </div>

        </form>

        <form id="formRole{{ u.id }}" method="post" action="{{ url_for('users_role', uid=u.id) }}"></form>
      </div>
    </dialog>

    {% endfor %}

  </div>
</div>



<!-- =======================================================
        MODAL NOVO USU√ÅRIO
======================================================= -->
<dialog id="modalNovoUsuario"
  class="rounded-2xl bg-gray-900 border border-gray-700 p-0 shadow-2xl w-[520px] max-w-[92vw] backdrop:bg-black/70">

  <div class="p-6 border-b border-white/10">
    <h2 class="text-xl font-bold text-white">Cadastrar colaborador</h2>
    <p class="text-sm text-gray-400 mt-1">Crie um novo usu√°rio com perfil de acesso.</p>
  </div>

  <div class="p-6">
    <form method="post" action="{{ url_for('users_new') }}" class="space-y-4">

      <div>
        <label class="text-xs text-gray-400 font-medium">Usu√°rio</label>
        <input name="username" required
          class="mt-1 w-full bg-gray-800/80 border border-gray-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner
                 focus:outline-none focus:ring-2 focus:ring-green-500/30">
      </div>

      <div>
        <label class="text-xs text-gray-400 font-medium">Senha</label>
        <input name="password" type="password" required
          class="mt-1 w-full bg-gray-800/80 border border-gray-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner
                 focus:outline-none focus:ring-2 focus:ring-green-500/30">
        <p class="text-[11px] text-gray-500 mt-1">Dica: use pelo menos 8 caracteres.</p>
      </div>

      <div>
        <label class="text-xs text-gray-400 font-medium">Perfil</label>
        <select name="role"
          class="mt-1 w-full bg-gray-800/80 border border-gray-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner
                 focus:outline-none focus:ring-2 focus:ring-green-500/30">
          <option value="tech">T√©cnico</option>
          <option value="supervisor">Supervisor</option>
          <option value="admin">Administrador</option>
          <option value="manutencao">Manuten√ß√£o</option>
        </select>
      </div>

      <div class="flex flex-wrap justify-end gap-3 pt-4">
        <button type="button"
          onclick="document.getElementById('modalNovoUsuario').close()"
          class="px-4 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-white text-sm
                 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/20">
          Cancelar
        </button>

        <button
          class="px-4 py-2 rounded-xl bg-green-600 hover:bg-green-700 text-white text-sm font-semibold shadow
                 focus:outline-none focus-visible:ring-2 focus-visible:ring-green-300/40">
          Criar colaborador
        </button>
      </div>

    </form>
  </div>
</dialog>

{% endblock %}
