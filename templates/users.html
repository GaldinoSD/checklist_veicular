{% extends 'layout.html' %}
{% set page_title = "Usu√°rios" %}
{% block content %}

<!-- =======================================================
        CABE√áALHO
======================================================= -->
<div class="flex items-center justify-between mb-10">
  <h2 class="text-4xl font-extrabold tracking-tight text-white">Colaboradores</h2>

  {% if ROLE_ADMIN %}
  <button onclick="document.getElementById('modalNovoUsuario').showModal()"
          class="px-5 py-2.5 rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold shadow-lg flex items-center gap-2 transition">
      <span class="text-lg">Ôºã</span> Novo
  </button>
  {% endif %}
</div>


<!-- =======================================================
        LISTA DE USU√ÅRIOS
======================================================= -->
<div class="rounded-xl overflow-hidden bg-white/5 backdrop-blur-xl border border-white/10">

  <div class="grid grid-cols-3 px-4 py-2 bg-white/10 text-xs font-semibold text-gray-300 uppercase tracking-wide">
    <div class="flex items-center">Usu√°rio</div>
    <div class="flex items-center">Fun√ß√£o</div>
    <div class="flex items-center justify-end">A√ß√µes</div>
  </div>

  <div class="divide-y divide-white/10">

    {% for u in items %}

    <div class="grid grid-cols-3 px-4 py-2.5 
        {% if u.username == 'admin' %}
            bg-yellow-500/10 border-l-4 border-yellow-400
        {% else %}
            hover:bg-white/10
        {% endif %}
        transition">

        <!-- COLUNA 1 ‚Äî NOME -->
        <div class="flex items-center gap-2">

          <!-- Avatar -->
          <div class="w-6 h-6 rounded-md 
                   {% if u.username == 'admin' %}
                      bg-gradient-to-br from-yellow-500 to-yellow-300 text-black
                   {% else %}
                      bg-gradient-to-br from-blue-700 to-blue-500 text-white
                   {% endif %}
                      flex items-center justify-center text-[10px] font-semibold shadow">
            {{ u.username[0] | upper }}
          </div>

          <!-- Nome + Coroa -->
          <span class="text-sm font-medium 
                {% if u.username == 'admin' %}
                  text-yellow-300 flex items-center gap-1
                {% else %}
                  text-white
                {% endif %}">
            {{ u.username }}

            {% if u.username == 'admin' %}
            <span title="Administrador Principal" class="text-yellow-300 text-base drop-shadow-lg">üëë</span>
            {% endif %}
          </span>
        </div>

        <!-- COLUNA 2 ‚Äî PAPEL -->
        <div class="flex items-center">
          <span class="text-[10px] px-2 py-0.5 rounded-full border w-fit font-semibold
            {% if u.username == 'admin' %}
                bg-yellow-500/20 text-yellow-300 border-yellow-400
            {% elif u.role == 'admin' %}
                bg-blue-900/40 text-blue-200 border-blue-700/40
            {% elif u.role == 'supervisor' %}
                bg-yellow-900/40 text-yellow-200 border-yellow-700/40
            {% elif u.role == 'manutencao' %}
                bg-purple-900/40 text-purple-200 border-purple-700/40
            {% else %}
                bg-gray-800/60 text-gray-300 border-gray-600/40
            {% endif %}">

            {% if u.username == "admin" %}
              Admin ‚Äî Principal
            {% elif u.role == "tech" %}
              T√©cnico
            {% else %}
              {{ u.role | capitalize }}
            {% endif %}
          </span>
        </div>


        <!-- COLUNA 3 ‚Äî A√á√ïES -->
        <div class="flex items-center justify-end gap-2">

          <button onclick="document.getElementById('modalEdit{{ u.id }}').showModal()"
                  class="px-2 py-1 text-[10px] rounded-md
                     {% if u.username == 'admin' %}
                        bg-yellow-500 hover:bg-yellow-400 text-black
                     {% else %}
                        bg-blue-600 hover:bg-blue-500 text-white
                     {% endif %}
                     font-medium shadow transition">
            Editar
          </button>

          {% if u.username != 'admin' %}
          <form method="post" action="{{ url_for('users_del', uid=u.id) }}"
                onsubmit="return confirm('Deseja realmente excluir {{ u.username }}?');">
            <button class="px-2 py-1 text-[10px] rounded-md bg-red-700 hover:bg-red-600 
                           text-white font-medium shadow transition">
              Excluir
            </button>
          </form>
          {% endif %}

        </div>

    </div>




    <!-- =======================================================
            MODAL DE EDI√á√ÉO
    ======================================================= -->
    <dialog id="modalEdit{{ u.id }}"
            class="rounded-2xl bg-gray-900 border border-gray-700 p-7 shadow-2xl w-[440px] backdrop:bg-black/60">

      <h2 class="text-2xl font-semibold text-white mb-5">Editar Colaborador</h2>

      <form method="post" action="{{ url_for('users_pwd', uid=u.id) }}" class="space-y-5">

        <div>
          <label class="text-xs text-gray-400 font-medium">Usu√°rio</label>
          <input value="{{ u.username }}" disabled
                class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2.5 text-gray-400 text-sm shadow-inner">
        </div>

        <div>
          <label class="text-xs text-gray-400 font-medium">Nova Senha</label>
          <input name="password" placeholder="Informe a nova senha"
                class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner">
        </div>

        {% if u.username == "admin" %}
        <div>
          <label class="text-xs text-red-400 font-medium">Senha Mestre</label>
          <input name="master_key" type="password" placeholder="Obrigat√≥ria para editar admin"
                 class="w-full bg-red-900/40 border border-red-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner">
        </div>
        {% endif %}

        {% if u.username != "admin" %}
        <div>
          <label class="text-xs text-gray-400 font-medium">Perfil</label>
          <select name="role"
                  form="formRole{{ u.id }}"
                  class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner">

            <option value="tech" {% if u.role == 'tech' %}selected{% endif %}>T√©cnico</option>
            <option value="supervisor" {% if u.role == 'supervisor' %}selected{% endif %}>Supervisor</option>
            <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>Administrador</option>
            <option value="manutencao" {% if u.role == 'manutencao' %}selected{% endif %}>Manuten√ß√£o</option>

          </select>
        </div>
        {% endif %}


        <div class="flex justify-end gap-3 pt-2">
          <button type="button"
                  onclick="document.getElementById('modalEdit{{ u.id }}').close()"
                  class="px-4 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-white text-sm">
            Cancelar
          </button>

          <button formaction="{{ url_for('users_pwd', uid=u.id) }}"
                  class="px-4 py-2 rounded-xl
                     {% if u.username == 'admin' %}
                        bg-yellow-500 hover:bg-yellow-400 text-black
                     {% else %}
                        bg-blue-600 hover:bg-blue-700 text-white
                     {% endif %}
                     text-sm font-semibold">
            Salvar Senha
          </button>

          {% if u.username != "admin" %}
          <button form="formRole{{ u.id }}"
                  class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-semibold">
            Atualizar Perfil
          </button>
          {% endif %}
        </div>

      </form>

      <form id="formRole{{ u.id }}" method="post" action="{{ url_for('users_role', uid=u.id) }}"></form>

    </dialog>

    {% endfor %}
  </div>
</div>



<!-- =======================================================
        MODAL ‚Äî NOVO COLABORADOR
======================================================= -->
<dialog id="modalNovoUsuario"
        class="rounded-2xl bg-gray-900 border border-gray-700 p-7 shadow-2xl w-[440px] backdrop:bg-black/60">

  <h2 class="text-2xl font-semibold text-white mb-5">Cadastrar Colaborador</h2>

  <form method="post" action="{{ url_for('users_new') }}" class="space-y-5">

    <div>
      <label class="text-xs text-gray-400 font-medium">Usu√°rio</label>
      <input name="username"
             class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner"
             required>
    </div>

    <div>
      <label class="text-xs text-gray-400 font-medium">Senha</label>
      <input name="password" type="text"
             class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner"
             required>
    </div>

    <div>
      <label class="text-xs text-gray-400 font-medium">Perfil</label>
      <select name="role"
              class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-2.5 text-white text-sm shadow-inner">
        <option value="tech">T√©cnico</option>
        <option value="supervisor">Supervisor</option>
        <option value="admin">Administrador</option>
        <option value="manutencao">Manuten√ß√£o</option>
      </select>
    </div>

    <div class="flex justify-end gap-3 pt-2">
      <button type="button"
              onclick="document.getElementById('modalNovoUsuario').close()"
              class="px-4 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-white text-sm">
        Cancelar
      </button>

      <button class="px-4 py-2 rounded-xl bg-green-600 hover:bg-green-700 text-white text-sm font-semibold">
        Criar Colaborador
      </button>
    </div>

  </form>

</dialog>

{% endblock %}
