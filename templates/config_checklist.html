{% extends 'layout.html' %}
{% set page_title = "Configura√ß√µes do Checklist" %}
{% block content %}

<div class="max-w-4xl mx-auto space-y-6">

  <!-- ======================= üîπ MODO DO CHECKLIST ======================= -->
  <div class="rounded-2xl shadow-lg p-6 border backdrop-blur
              bg-white/70 border-slate-900/10
              dark:bg-white/5 dark:border-white/10">
    <h2 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Modo do Checklist</h2>

    <form method="post" action="{{ url_for('config_checklist_mode') }}" class="space-y-3">
      <label class="text-sm text-slate-700 dark:text-gray-300">Selecione o modo de funcionamento:</label>

      <select name="mode"
        class="w-full rounded-lg px-3 py-2 border cursor-pointer
               bg-white text-slate-900 border-slate-900/10
               dark:bg-gray-900/60 dark:text-white dark:border-white/10
               focus:outline-none focus:ring-2 focus:ring-blue-600/30">
        <option value="disabled" {% if config.mode=='disabled' %}selected{% endif %}>‚ùå Desativado</option>
        <option value="start_only" {% if config.mode=='start_only' %}selected{% endif %}>üü¶ Somente In√≠cio</option>
        <option value="start_end" {% if config.mode=='start_end' %}selected{% endif %}>üü© In√≠cio e Chegada</option>
      </select>

      <button
        class="rounded-lg px-5 py-2 font-semibold text-white shadow-lg transition
               bg-green-700 hover:bg-green-600 hover:shadow-green-700/30">
        üíæ Salvar Modo
      </button>
    </form>
  </div>

  <!-- ======================= üîπ ADICIONAR NOVA PERGUNTA ======================= -->
  <div class="rounded-2xl shadow-lg p-6 border backdrop-blur
              bg-white/70 border-slate-900/10
              dark:bg-white/5 dark:border-white/10">
    <h2 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Adicionar Pergunta</h2>

    <form method="post" action="{{ url_for('config_checklist_new') }}" class="space-y-4" id="new-item-form">

      <div class="grid md:grid-cols-2 gap-3">
        <input name="text" placeholder="Texto da pergunta"
          class="rounded-lg px-3 py-2 border
                 bg-white text-slate-900 border-slate-900/10
                 dark:bg-gray-900/60 dark:text-white dark:border-white/10
                 focus:outline-none focus:ring-2 focus:ring-blue-600/30">

        <select name="type"
          class="rounded-lg px-3 py-2 border cursor-pointer type-select
                 bg-white text-slate-900 border-slate-900/10
                 dark:bg-gray-900/60 dark:text-white dark:border-white/10
                 focus:outline-none focus:ring-2 focus:ring-blue-600/30"
          onchange="toggleOptions(this)">

          <option value="texto_curto">Texto curto</option>
          <option value="paragrafo">Par√°grafo</option>
          <option value="numero">N√∫mero</option>
          <option value="data">Data</option>
          <option value="sim_nao_na">Sim / N√£o / N/A</option>
          <option value="dropdown">Lista suspensa</option>
          <option value="radio">Sele√ß√£o √∫nica</option>
          <option value="checkboxes">Sele√ß√£o m√∫ltipla</option>
        </select>
      </div>

      <!-- Op√ß√µes din√¢micas -->
      <div class="hidden options-box rounded-xl border p-4
                  bg-slate-900/3 border-slate-900/10
                  dark:bg-black/10 dark:border-white/10">
        <label class="text-sm mb-2 block text-slate-600 dark:text-gray-400">Op√ß√µes</label>

        <div class="space-y-2" id="option-list"></div>

        <button type="button" onclick="addOptionField(this)"
          class="mt-2 rounded px-3 py-1 text-sm font-semibold text-white
                 bg-blue-700 hover:bg-blue-600">
          ‚ûï Adicionar op√ß√£o
        </button>

        <input type="hidden" name="options" id="options-hidden">
      </div>

      <!-- Configura√ß√µes extras -->
      <div class="flex flex-wrap gap-4 items-center">

        <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-gray-300">
          <input type="checkbox" name="required" class="accent-blue-600"> Obrigat√≥ria
        </label>

        <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-gray-300">
          <input type="checkbox" name="require_justif_no" class="accent-yellow-500">
          Exigir justificativa se 'N√£o'
        </label>

        <button type="button" onclick="prepareOptions(this)"
          class="ml-auto rounded-lg px-5 py-2 font-semibold text-white shadow-lg transition
                 bg-green-700 hover:bg-green-600 hover:shadow-green-700/30">
          ‚ûï Adicionar
        </button>
      </div>
    </form>
  </div>

  <!-- ======================= üîπ LISTAGEM DE PERGUNTAS EXISTENTES ======================= -->
  {% for it in items %}
  <div class="rounded-2xl shadow-lg p-6 border backdrop-blur
              bg-white/70 border-slate-900/10
              dark:bg-white/5 dark:border-white/10">

    <div class="flex items-start justify-between gap-3">
      <div class="flex-1">
        <form method="post" action="{{ url_for('config_checklist_edit', iid=it.id) }}" class="space-y-3">

          <div class="grid md:grid-cols-2 gap-3">
            <input name="text" value="{{ it.text }}"
              class="rounded-lg px-3 py-2 border
                     bg-white text-slate-900 border-slate-900/10
                     dark:bg-gray-900/60 dark:text-white dark:border-white/10
                     focus:outline-none focus:ring-2 focus:ring-blue-600/30">

            <select name="type"
              class="rounded-lg px-3 py-2 border cursor-pointer type-select
                     bg-white text-slate-900 border-slate-900/10
                     dark:bg-gray-900/60 dark:text-white dark:border-white/10
                     focus:outline-none focus:ring-2 focus:ring-blue-600/30"
              onchange="toggleOptions(this)">
              <option value="texto_curto" {% if it.type=='texto_curto' %}selected{% endif %}>Texto curto</option>
              <option value="paragrafo" {% if it.type=='paragrafo' %}selected{% endif %}>Par√°grafo</option>
              <option value="numero" {% if it.type=='numero' %}selected{% endif %}>N√∫mero</option>
              <option value="data" {% if it.type=='data' %}selected{% endif %}>Data</option>
              <option value="sim_nao_na" {% if it.type=='sim_nao_na' %}selected{% endif %}>Sim / N√£o / N/A</option>
              <option value="dropdown" {% if it.type=='dropdown' %}selected{% endif %}>Lista suspensa</option>
              <option value="radio" {% if it.type=='radio' %}selected{% endif %}>Sele√ß√£o √∫nica</option>
              <option value="checkboxes" {% if it.type=='checkboxes' %}selected{% endif %}>Sele√ß√£o m√∫ltipla</option>
            </select>
          </div>

          <!-- Op√ß√µes -->
          <div class="{% if it.type in ['dropdown','radio','checkboxes'] %}{% else %}hidden{% endif %} options-box
                      rounded-xl border p-4
                      bg-slate-900/3 border-slate-900/10
                      dark:bg-black/10 dark:border-white/10">

            <label class="text-sm text-slate-600 dark:text-gray-400">Op√ß√µes</label>

            <div class="space-y-2 option-list-edit mt-2">
              {% for opt in (it.options.split(',') if it.options else []) %}
              <div class="flex gap-2 items-center">
                <input type="text" name="option_inputs" value="{{ opt }}"
                  class="rounded px-3 py-1 flex-1 border
                         bg-white text-slate-900 border-slate-900/10
                         dark:bg-gray-900/60 dark:text-white dark:border-white/10">
                <button type="button" onclick="this.parentNode.remove()"
                  class="rounded px-2 py-1 text-white bg-red-700 hover:bg-red-600">üóë</button>
              </div>
              {% endfor %}
            </div>

            <button type="button" onclick="addOptionFieldEdit(this)"
              class="mt-3 rounded px-3 py-1 text-sm font-semibold text-white
                     bg-blue-700 hover:bg-blue-600">
              ‚ûï Adicionar op√ß√£o
            </button>

            <input type="hidden" name="options" class="options-hidden-edit">
          </div>

          <!-- Justificativa (visual) -->
          <div>
            <label class="block text-sm mb-1 text-slate-600 dark:text-gray-400">Campo de justificativa (apenas visual)</label>
            <input type="text" disabled placeholder="Este campo ser√° exibido no checklist"
              class="w-full rounded px-3 py-2 text-sm italic border
                     bg-slate-900/5 text-slate-500 border-slate-900/10
                     dark:bg-white/5 dark:text-gray-400 dark:border-white/10">
          </div>

          <!-- A√ß√µes -->
          <div class="flex flex-wrap items-center gap-4">
            <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-gray-300">
              <input type="checkbox" name="required" {% if it.required %}checked{% endif %} class="accent-blue-600">
              Obrigat√≥ria
            </label>

            <label class="inline-flex items-center gap-2 text-sm text-slate-700 dark:text-gray-300">
              <input type="checkbox" name="require_justif_no" {% if it.require_justif_no %}checked{% endif %}
                class="accent-yellow-500">
              Exigir justificativa se 'N√£o'
            </label>

            <button type="button" onclick="prepareOptions(this)"
              class="ml-auto rounded px-4 py-2 text-sm font-semibold text-white shadow transition
                     bg-indigo-600 hover:bg-indigo-500 hover:shadow-indigo-700/30">
              üíæ Salvar
            </button>
          </div>
        </form>
      </div>

      <!-- Bot√µes laterais -->
      <div class="flex flex-col gap-2 shrink-0">
        <form method="post" action="{{ url_for('config_checklist_move', iid=it.id) }}">
          <input type="hidden" name="dir" value="up">
          <button title="Mover para cima"
            class="rounded px-2 py-1 border
                   bg-white/60 border-slate-900/10 text-slate-800 hover:bg-white
                   dark:bg-white/5 dark:border-white/10 dark:text-white dark:hover:bg-white/10">‚ñ≤</button>
        </form>

        <form method="post" action="{{ url_for('config_checklist_move', iid=it.id) }}">
          <input type="hidden" name="dir" value="down">
          <button title="Mover para baixo"
            class="rounded px-2 py-1 border
                   bg-white/60 border-slate-900/10 text-slate-800 hover:bg-white
                   dark:bg-white/5 dark:border-white/10 dark:text-white dark:hover:bg-white/10">‚ñº</button>
        </form>

        <form method="post" action="{{ url_for('config_checklist_del', iid=it.id) }}"
              onsubmit="return confirm('Excluir item?');">
          <button
            class="rounded px-3 py-2 text-white shadow transition
                   bg-red-700 hover:bg-red-600 hover:shadow-red-700/30">
            üóë Excluir
          </button>
        </form>
      </div>
    </div>
  </div>

  {% else %}
    <div class="text-center text-sm mt-10 text-slate-500 dark:text-gray-400">
      Nenhuma pergunta cadastrada ainda.
    </div>
  {% endfor %}

</div>

<!-- ======================= JAVASCRIPT ======================= -->
<script>
function toggleOptions(selectEl) {
  const form = selectEl.closest('form');
  const box = form.querySelector('.options-box');
  if (!box) return;

  const type = selectEl.value;
  if (['dropdown', 'radio', 'checkboxes'].includes(type)) {
    box.classList.remove('hidden');
  } else {
    box.classList.add('hidden');
  }
}

function addOptionField(btn) {
  const list = btn.parentElement.querySelector('#option-list');
  const div = document.createElement('div');
  div.className = 'flex gap-2 items-center';
  div.innerHTML = `
    <input type="text" class="option-input flex-1 rounded px-3 py-1 border
      bg-white text-slate-900 border-slate-900/10
      dark:bg-gray-900/60 dark:text-white dark:border-white/10"
      placeholder="Digite uma op√ß√£o...">
    <button type="button" onclick="this.parentNode.remove()"
      class="rounded px-2 py-1 text-white bg-red-700 hover:bg-red-600">üóë</button>
  `;
  list.appendChild(div);
}

function addOptionFieldEdit(btn) {
  const list = btn.parentElement.querySelector('.option-list-edit');
  const div = document.createElement('div');
  div.className = 'flex gap-2 items-center';
  div.innerHTML = `
    <input type="text" name="option_inputs" class="flex-1 rounded px-3 py-1 border
      bg-white text-slate-900 border-slate-900/10
      dark:bg-gray-900/60 dark:text-white dark:border-white/10"
      placeholder="Digite uma op√ß√£o...">
    <button type="button" onclick="this.parentNode.remove()"
      class="rounded px-2 py-1 text-white bg-red-700 hover:bg-red-600">üóë</button>
  `;
  list.appendChild(div);
}

function prepareOptions(btn) {
  const form = btn.closest('form');
  const inputs = form.querySelectorAll('.option-input, [name="option_inputs"]');
  const values = [...inputs].map(i => i.value.trim()).filter(v => v !== '');
  const hidden = form.querySelector('input[name="options"], .options-hidden-edit');
  if (hidden) hidden.value = values.join(',');
}
</script>

{% endblock %}
