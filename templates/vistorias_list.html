{% extends 'layout.html' %}
{% set page_title = "Vistoria" %}
{% block content %}

<form method="get"
      class="flex flex-wrap items-end gap-3
             bg-white/70 dark:bg-gray-800/40
             p-4 rounded-xl
             border border-slate-900/10 dark:border-gray-700
             mb-6">

  <div class="flex flex-col text-slate-700 dark:text-gray-300 text-xs">
    <label for="periodo">Período</label>
    <input id="periodo" type="text" name="periodo"
           value="{{ request.args.get('periodo', '') }}"
           placeholder="Selecione o período"
           class="bg-white dark:bg-gray-900
                  border border-slate-900/10 dark:border-gray-700
                  text-slate-900 dark:text-gray-200
                  placeholder:text-slate-400 dark:placeholder:text-gray-500
                  px-3 py-2 rounded-md w-64
                  focus:outline-none focus:ring-2 focus:ring-blue-600/40">
  </div>

  <div class="flex flex-col text-slate-700 dark:text-gray-300 text-xs">
    <label for="veiculo">Veículo</label>
    <select id="veiculo" name="veiculo"
            class="bg-white dark:bg-gray-900
                   border border-slate-900/10 dark:border-gray-700
                   text-slate-900 dark:text-gray-200
                   px-3 py-2 rounded-md w-56
                   focus:outline-none focus:ring-2 focus:ring-blue-600/40">
      <option value="">Todos</option>
      {% for ve in veiculos %}
        <option value="{{ ve.id }}"
          {% if request.args.get('veiculo') == ve.id|string %} selected {% endif %}>
          {{ ve.plate }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="flex flex-col text-slate-700 dark:text-gray-300 text-xs">
    <label for="status">Status</label>
    <select id="status" name="status"
            class="bg-white dark:bg-gray-900
                   border border-slate-900/10 dark:border-gray-700
                   text-slate-900 dark:text-gray-200
                   px-3 py-2 rounded-md w-48
                   focus:outline-none focus:ring-2 focus:ring-blue-600/40">
      <option value="">Todos</option>
      <option value="ok" {% if request.args.get('status')=='ok' %}selected{% endif %}>OK</option>
      <option value="avarias" {% if request.args.get('status')=='avarias' %}selected{% endif %}>Com avarias</option>
    </select>
  </div>

  <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
    Filtrar
  </button>

  <a href="{{ url_for('vistorias_list') }}"
     class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg text-sm">
    Limpar
  </a>

  <a href="{{ url_for('vistorias_nova') }}"
     class="ml-auto px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">
    + Nova vistoria
  </a>
</form>

<div class="bg-white/70 dark:bg-white/5 border border-slate-900/10 dark:border-white/10 rounded-2xl shadow overflow-hidden">
  <div class="p-5 border-b border-slate-900/10 dark:border-white/10">
    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Últimas vistorias</h3>
  </div>

  <div class="p-5 overflow-x-auto">
    <table class="min-w-full text-left text-sm">
      <thead>
        <tr class="text-slate-600 dark:text-gray-300">
          <th class="py-2 pr-4">Data</th>
          <th class="py-2 pr-4">Placa</th>
          <th class="py-2 pr-4">KM</th>
          <th class="py-2 pr-4">Status</th>
          <th class="py-2 pr-4">Fotos</th>
          <th class="py-2 pr-4">Detalhes</th>
        </tr>
      </thead>
      <tbody class="text-slate-900 dark:text-gray-200">
        {% for r in registros %}
          <tr class="border-t border-slate-900/10 dark:border-white/10 hover:bg-slate-900/5 dark:hover:bg-white/5 transition">
            <td class="py-2 pr-4 whitespace-nowrap">{{ r.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
            <td class="py-2 pr-4">{{ r.vehicle.plate }}</td>
            <td class="py-2 pr-4">{{ r.km or '-' }}</td>
            <td class="py-2 pr-4">
              {% if r.status_geral == 'avarias' %}
                <span class="px-2 py-1 rounded-lg text-xs
                             bg-yellow-200/70 dark:bg-yellow-900/40
                             text-yellow-900 dark:text-yellow-200
                             border border-yellow-500/25 dark:border-yellow-700/40">
                  Com avarias
                </span>
              {% else %}
                <span class="px-2 py-1 rounded-lg text-xs
                             bg-green-200/70 dark:bg-green-900/40
                             text-green-900 dark:text-green-200
                             border border-green-500/25 dark:border-green-700/40">
                  OK
                </span>
              {% endif %}
            </td>
            <td class="py-2 pr-4">{{ r.fotos|length }}</td>
            <td class="py-2 pr-4">
              <a class="text-blue-700 dark:text-blue-400 underline" href="{{ url_for('vistorias_detail', vistoria_id=r.id) }}">Ver</a>
            </td>
          </tr>
        {% else %}
          <tr>
            <td class="py-3 text-slate-500 dark:text-gray-400" colspan="6">Sem registros.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Litepicker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
<script>
new Litepicker({
  element: document.getElementById('periodo'),
  singleMode: false,
  numberOfMonths: 2,
  numberOfColumns: 2,
  format: 'YYYY-MM-DD',
  delimiter: ' - ',
  autoApply: true
});
</script>

{% endblock %}
