{% extends 'layout.html' %}
{% set page_title = "Checklist T√©cnico" %}
{% block content %}
<div class="max-w-3xl mx-auto space-y-6">

  <!-- ====================== TOPO ====================== -->
<div class="flex items-center justify-between p-4 rounded-2xl border shadow backdrop-blur
            bg-white/70 border-slate-900/10
            dark:bg-white/5 dark:border-white/10">

  <h2 class="text-xl font-semibold text-slate-900 dark:text-white flex items-center gap-2">
    Checklist T√©cnico
  </h2>

  <div class="flex items-center gap-3">
    <span class="text-sm text-slate-700 dark:text-gray-300">üë∑ {{ current_user.username }}</span>

    <button type="button"
            onclick="openModal('modalSenha')"
            class="text-sm px-3 py-1.5 rounded-lg border transition
                   bg-slate-900/5 hover:bg-slate-900/10 text-slate-900 border-slate-900/10
                   dark:bg-gray-900/60 dark:hover:bg-gray-900/80 dark:text-white dark:border-white/10">
      üîí Mudar senha
    </button>
  </div>
</div>


  <!-- ====================== MENSAGENS DO MODO ====================== -->
  {% if disabled %}
    <div class="p-4 rounded-xl text-center shadow border
                bg-red-600/10 border-red-600/20 text-red-800
                dark:bg-red-700/60 dark:border-red-500 dark:text-white">
      üö´ O checklist est√° <b>desativado</b> pelo supervisor.
    </div>
  {% endif %}

  {% if not disabled %}
    {% if mode == "start_only" %}
      <div class="p-4 rounded-xl text-center shadow border
                  bg-blue-600/10 border-blue-600/20 text-blue-800
                  dark:bg-blue-700/40 dark:border-blue-500 dark:text-blue-100">
        üìå <b>Modo: Somente In√≠cio</b><br>
        Voc√™ far√° apenas <b>1 checklist por dia</b>.
      </div>
    {% elif mode == "start_end" %}
      <div class="p-4 rounded-xl text-center shadow border
                  bg-purple-600/10 border-purple-600/20 text-purple-900
                  dark:bg-purple-700/40 dark:border-purple-500 dark:text-purple-100">
        üìå <b>Modo: In√≠cio + Chegada</b><br>
        Ser√£o 2 checklists por dia:<br>
        ‚Ä¢ <b>In√≠cio</b><br>
        ‚Ä¢ <b>Chegada</b> (obrigatoriamente do mesmo ve√≠culo)
      </div>
    {% endif %}
  {% endif %}

  {% if current_step %}
    <div class="p-3 rounded-xl text-center shadow border
                bg-slate-900/5 border-slate-900/10 text-slate-800
                dark:bg-gray-800/60 dark:border-gray-600 dark:text-gray-100">
      üìç Este checklist √©:
      <span class="font-bold text-slate-900 dark:text-white uppercase">
        {{ "IN√çCIO" if current_step == "start" else "CHEGADA" }}
      </span>
    </div>
  {% endif %}

  <!-- ====================== FORMUL√ÅRIO ====================== -->
  <div class="rounded-2xl shadow-xl p-6 border backdrop-blur
              bg-white/70 border-slate-900/10
              dark:bg-white/5 dark:border-white/10">

    {% if disabled %}
      <div class="text-center py-10 text-slate-500 dark:text-gray-400">
        üö´ O checklist est√° indispon√≠vel no momento.
      </div>
    {% else %}

      <form method="post" enctype="multipart/form-data" class="space-y-6">

        <!-- VE√çCULO + KM -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-slate-700 dark:text-gray-300">Ve√≠culo</label>
            <select name="vehicle_id" required
              class="w-full rounded-lg px-3 py-2 border
                     bg-white text-slate-900 border-slate-900/10
                     dark:bg-gray-900/60 dark:text-white dark:border-white/10
                     focus:outline-none focus:ring-2 focus:ring-blue-600/30">
              <option value="">Selecione...</option>
              {% for v in vehicles %}
                <option value="{{ v.id }}">{{ v.plate }} ‚Äî {{ v.brand }} {{ v.model }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="text-sm text-slate-700 dark:text-gray-300">KM atual</label>
            <input type="number" name="km" min="0" required
              class="w-full rounded-lg px-3 py-2 border
                     bg-white text-slate-900 border-slate-900/10
                     dark:bg-gray-900/60 dark:text-white dark:border-white/10
                     focus:outline-none focus:ring-2 focus:ring-blue-600/30">
          </div>
        </div>

        <hr class="border-slate-900/10 dark:border-white/10 my-4">

        <!-- ====================== PERGUNTAS ====================== -->
        {% for q in items %}
        {% set q_index = loop.index %}
        <div class="rounded-xl p-4 shadow-md border
                    bg-white/60 border-slate-900/10
                    dark:bg-gray-900/60 dark:border-white/10">
          <label class="block font-semibold mb-2 text-slate-900 dark:text-gray-100">
            {{ q_index }}. {{ q.text }}
          </label>

          {% if q.type == 'texto_curto' %}
            <input type="text" name="item{{ q_index }}"
              class="w-full rounded px-3 py-2 border
                     bg-white text-slate-900 border-slate-900/10
                     dark:bg-gray-800 dark:text-white dark:border-white/10
                     focus:outline-none focus:ring-2 focus:ring-blue-600/30">

          {% elif q.type == 'paragrafo' %}
            <textarea name="item{{ q_index }}" rows="3"
              class="w-full rounded px-3 py-2 border
                     bg-white text-slate-900 border-slate-900/10
                     dark:bg-gray-800 dark:text-white dark:border-white/10
                     focus:outline-none focus:ring-2 focus:ring-blue-600/30"></textarea>

          {% elif q.type == 'numero' %}
            <input type="number" name="item{{ q_index }}"
              class="w-full rounded px-3 py-2 border
                     bg-white text-slate-900 border-slate-900/10
                     dark:bg-gray-800 dark:text-white dark:border-white/10
                     focus:outline-none focus:ring-2 focus:ring-blue-600/30">

          {% elif q.type == 'data' %}
            <input type="date" name="item{{ q_index }}"
              class="w-full rounded px-3 py-2 border
                     bg-white text-slate-900 border-slate-900/10
                     dark:bg-gray-800 dark:text-white dark:border-white/10
                     focus:outline-none focus:ring-2 focus:ring-blue-600/30">

          {% elif q.type == 'sim_nao_na' %}
            <div class="flex flex-wrap gap-4 text-slate-800 dark:text-white">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="item{{ q_index }}" value="Sim" class="accent-blue-600"> Sim
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="item{{ q_index }}" value="N√£o" class="accent-blue-600"> N√£o
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="item{{ q_index }}" value="N/A" class="accent-blue-600"> N/A
              </label>
            </div>

          {% elif q.type == 'dropdown' %}
            <select name="item{{ q_index }}"
              class="w-full rounded px-3 py-2 border
                     bg-white text-slate-900 border-slate-900/10
                     dark:bg-gray-800 dark:text-white dark:border-white/10
                     focus:outline-none focus:ring-2 focus:ring-blue-600/30">
              <option value="">Selecione...</option>
              {% for opt in q.options.split(',') %}
                <option value="{{ opt }}">{{ opt }}</option>
              {% endfor %}
            </select>

          {% elif q.type == 'radio' %}
            <div class="flex flex-col gap-2 text-slate-800 dark:text-white">
              {% for opt in q.options.split(',') %}
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="item{{ q_index }}" value="{{ opt }}" class="accent-blue-600">
                {{ opt }}
              </label>
              {% endfor %}
            </div>

          {% elif q.type == 'checkboxes' %}
            <div class="flex flex-col gap-2 text-slate-800 dark:text-white">
              {% for opt in q.options.split(',') %}
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" name="item{{ q_index }}" value="{{ opt }}" class="accent-blue-600">
                {{ opt }}
              </label>
              {% endfor %}
            </div>
          {% endif %}

          {% if q.type != 'data' %}
          <div class="mt-3">
            <label class="block text-sm mb-1 text-slate-600 dark:text-gray-400">
              Justificativa (opcional)
            </label>
            <textarea name="item{{ q_index }}_just" rows="2"
              class="w-full rounded px-3 py-2 text-sm border
                     bg-white text-slate-900 border-slate-900/10
                     dark:bg-gray-800 dark:text-gray-200 dark:border-white/10
                     focus:outline-none focus:ring-2 focus:ring-blue-600/30"></textarea>
          </div>
          {% endif %}
        </div>
        {% endfor %}

        <!-- FOTOS -->
        <div>
          <label class="text-sm mb-2 block text-slate-700 dark:text-gray-300">Fotos (opcional)</label>
          <input type="file" name="fotos" multiple accept="image/*"
            class="block w-full text-sm rounded-lg p-2 border
                   bg-white text-slate-700 border-slate-900/10
                   file:mr-3 file:rounded-lg file:border-0 file:px-3 file:py-2
                   file:bg-slate-900/5 file:text-slate-800 hover:file:bg-slate-900/10
                   dark:bg-gray-900/60 dark:text-gray-200 dark:border-white/10
                   dark:file:bg-white/10 dark:file:text-gray-200 dark:hover:file:bg-white/15">
        </div>

        <!-- BOT√ÉO -->
        <div class="mt-8 text-right">
          <button
            class="rounded-lg px-6 py-2 text-sm font-semibold text-white shadow-md transition
                   bg-green-700 hover:bg-green-600 hover:shadow-green-700/30">
            üì§ Enviar Checklist
          </button>
        </div>
      </form>

      {% if success %}
      <div class="mt-6 text-center font-semibold text-green-700 dark:text-green-400">
        ‚úÖ Checklist enviado com sucesso!
      </div>
      {% endif %}

    {% endif %}
  </div>

</div>

<!-- ====================== MODAL: MUDAR SENHA ====================== -->
<div id="modalSenha" class="fixed inset-0 hidden items-center justify-center z-[80]">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"
       onclick="closeModal('modalSenha')"></div>

  <div class="relative w-[92%] max-w-md rounded-2xl border shadow-2xl p-5
              bg-white border-slate-900/10
              dark:bg-gray-900/80 dark:border-white/10">

    <div class="flex items-start justify-between gap-3">
      <div>
        <h3 class="text-lg font-bold text-slate-900 dark:text-white">üîí Mudar senha</h3>
        <p class="text-xs mt-1 text-slate-600 dark:text-gray-300">Use uma senha forte e n√£o compartilhe.</p>
      </div>

      <button type="button"
              class="px-2 py-1 rounded-lg border transition
                     bg-slate-900/5 hover:bg-slate-900/10 text-slate-700 border-slate-900/10
                     dark:bg-white/5 dark:hover:bg-white/10 dark:text-gray-200 dark:border-white/10"
              onclick="closeModal('modalSenha')"
              aria-label="Fechar">
        ‚úï
      </button>
    </div>

    <form method="post" action="{{ url_for('perfil_alterar_senha') }}" class="mt-4 space-y-3">

      <div>
        <label class="text-sm text-slate-700 dark:text-gray-300">Senha atual</label>
        <input type="password" name="current_password" required
               class="mt-1 w-full rounded-lg px-3 py-2 border
                      bg-white text-slate-900 border-slate-900/10
                      dark:bg-gray-900/60 dark:text-white dark:border-white/10
                      focus:outline-none focus:ring-2 focus:ring-blue-600/30">
      </div>

      <div>
        <label class="text-sm text-slate-700 dark:text-gray-300">Nova senha</label>
        <input type="password" name="new_password" minlength="6" required
               class="mt-1 w-full rounded-lg px-3 py-2 border
                      bg-white text-slate-900 border-slate-900/10
                      dark:bg-gray-900/60 dark:text-white dark:border-white/10
                      focus:outline-none focus:ring-2 focus:ring-blue-600/30">
        <p class="text-[11px] mt-1 text-slate-500 dark:text-gray-400">Recomendado: 6+ caracteres.</p>
      </div>

      <div>
        <label class="text-sm text-slate-700 dark:text-gray-300">Confirmar nova senha</label>
        <input type="password" name="confirm_password" minlength="6" required
               class="mt-1 w-full rounded-lg px-3 py-2 border
                      bg-white text-slate-900 border-slate-900/10
                      dark:bg-gray-900/60 dark:text-white dark:border-white/10
                      focus:outline-none focus:ring-2 focus:ring-blue-600/30">
      </div>

      <div class="pt-2 flex items-center justify-end gap-2">
        <button type="button"
                onclick="closeModal('modalSenha')"
                class="px-4 py-2 rounded-lg text-sm border transition
                       bg-slate-900/5 hover:bg-slate-900/10 text-slate-800 border-slate-900/10
                       dark:bg-white/5 dark:hover:bg-white/10 dark:text-gray-200 dark:border-white/10">
          Cancelar
        </button>

        <button type="submit"
                class="px-4 py-2 rounded-lg text-sm font-semibold text-white border border-blue-400/30
                       bg-blue-600 hover:bg-blue-700">
          Salvar
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function openModal(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.remove("hidden");
    el.classList.add("flex");
    document.documentElement.classList.add("overflow-hidden");
  }

  function closeModal(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.add("hidden");
    el.classList.remove("flex");
    document.documentElement.classList.remove("overflow-hidden");
  }

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      closeModal("modalSenha");
    }
  });
</script>

{% endblock %}
